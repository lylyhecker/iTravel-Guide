<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ƒê·ªïi qu√†</title>

  <!-- Tailwind ch·ªâ d√πng cho layout/spacing -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon (ThemeManager s·∫Ω ƒë·ªïi) -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg"/>

  <style>
    /* ========= THEME (y h·ªát quiz) ========= */
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
        --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626;
        --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .icon { width: 18px; height: 18px; object-fit: contain; display:inline-block }
    .muted{ color: var(--muted); }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background: var(--primary); color:white; font-weight:700;
      padding:10px 14px; border-radius:12px;
      transition: transform .12s ease, background .2s ease;
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--primary-strong); }
    .btn.secondary{ background: transparent; color: var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background: var(--bg-soft); }

    /* Thanh s·ªë d∆∞ */
    #balance-wrap{ display:flex; align-items:center; gap:10px; }
    #balance-bar{ width: 160px; height: 10px; background: var(--bg-soft); border:1px solid var(--border); border-radius: 999px; overflow: hidden; }
    #balance-fill{ height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), #60a5fa); transition: width 0.35s ease; }
    #balance-text{ font-size: 12px; color: var(--muted); }

    /* Toast */
    .toast{ position:fixed; top:16px; right:16px; max-width:320px; z-index:60; background:var(--card); color:var(--text); border:1px solid var(--border); border-left:4px solid var(--primary); border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); opacity:0; transform: translateY(-6px); transition: all .25s ease; pointer-events:none; }
    .toast.show{ opacity:1; transform:none; pointer-events:auto }
    .toast.success{ border-left-color:#22c55e } .toast.error{ border-left-color:#ef4444 } .toast.info{ border-left-color:var(--primary) }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header shadow-md">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl ring-1 ring-white/10 grid place-items-center" style="background:linear-gradient(135deg,var(--primary),#60a5fa)">
          <img src="assets/gift.svg" class="icon" alt="">
        </div>
        <div>
          <h1 class="text-lg font-extrabold" data-i18n="redeemTitle">ƒê·ªïi qu√†</h1>
          <div class="text-xs muted" id="statusSub" data-i18n="subTitle">Ch·ªçn qu√† ƒë·ªÉ ƒë·ªïi</div>
        </div>
      </div>

      <!-- User + s·ªë d∆∞ (ƒêi·ªÉm/XP) + controls -->
      <div class="flex items-center gap-4 flex-wrap">
        <div class="text-right">
          <div id="userName" class="font-bold" data-i18n="guestName">Kh√°ch</div>
          <div id="userStatsLine" class="text-sm muted"></div>
          <div id="balance-wrap" class="mt-1" style="display:none">
            <div id="balance-bar"><div id="balance-fill"></div></div>
            <span id="balance-text"></span>
          </div>
        </div>

        <a class="btn secondary" href="library.html"><img src="assets/book.svg" class="icon" alt=""> <span data-i18n="library">Th∆∞ vi·ªán</span></a>
        <button class="btn secondary" id="themeBtn" title="ƒê·ªïi giao di·ªán"><img id="themeIcon" class="icon" alt=""></button>
        <select id="langSelect" class="btn secondary" title="Language">
          <option value="vi">üáªüá≥ VI</option>
          <option value="en">üá¨üáß EN</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="card p-5">
      <h2 class="text-xl font-bold mb-3 flex items-center gap-2"><img src="assets/gift.svg" class="icon" alt=""> <span data-i18n="listTitle">Danh s√°ch qu√†</span></h2>
      <div id="gift-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-sm muted">
      ¬© 2025 Quiz & Assistant Web ‚Äî Design by Mr.Hecker
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast"><strong id="toast-title"></strong><div id="toast-msg" class="mt-1 text-sm"></div></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(); const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    function toast(title,msg,type='info',after=null){
      const t=$('toast'); $('toast-title').textContent=title; $('toast-msg').textContent=msg;
      t.className='toast '+type; requestAnimationFrame(()=>t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); after&&after(); }, 2300);
    }

    // ========= User Info & Balance (ƒêi·ªÉm ho·∫∑c XP) =========
    let currentUser=null;
    let balanceLabel='ƒêi·ªÉm';  // "ƒêi·ªÉm" ho·∫∑c "XP" (s·∫Ω ƒë∆∞·ª£c d·ªãch theo lang)
    let balanceValue=0;       // s·ªë d∆∞ hi·ªán d√πng ƒë·ªÉ ƒë·ªïi
    let hasPointsField=false; // true n·∫øu user c√≥ 'points' trong Firestore
    let userLevel=1, userXP=0;

    // Sanitize t√™n nh∆∞ quiz
    function sanitizeUsername(name){
      if (!name) return LangManager.t('guestName','Kh√°ch');
      const ascii = name.normalize("NFKD").replace(/[^\x00-\x7F]/g,"");
      const cleaned = ascii.replace(/\s+/g,"-").replace(/[^a-zA-Z0-9_-]/g,"");
      return cleaned || LangManager.t('guestName','Kh√°ch');
    }

    async function loadUserStats(){
      if (!auth.currentUser) return;
      const ref = db.collection('users').doc(auth.currentUser.uid);
      const snap = await ref.get();
      const data = snap.data() || {};

      // ∆Øu ti√™n 'points'. N·∫øu kh√¥ng c√≥ points m√† c√≥ 'xp' => d√πng XP
      if (typeof data.points === 'number'){
        hasPointsField = true;
        balanceLabel = LangManager.t('points','ƒêi·ªÉm');
        balanceValue = Number(data.points || 0);
      } else if (typeof data.xp === 'number'){
        hasPointsField = false;
        balanceLabel = 'XP'; // gi·ªØ nguy√™n, qu·ªëc t·∫ø ho√° trong UI b·∫±ng c√°ch hi·ªÉn th·ªã "XP"
        balanceValue = Number(data.xp || 0);
      } else {
        hasPointsField = true; // m·∫∑c ƒë·ªãnh t·∫°o points
        balanceLabel = LangManager.t('points','ƒêi·ªÉm');
        balanceValue = 0;
        // kh·ªüi t·∫°o points=0 ƒë·ªÉ l·∫ßn sau d√πng "ƒêi·ªÉm"
        await ref.set({ points: 0 }, { merge:true });
      }

      userLevel = Number(data.level || 1);
      userXP    = Number(data.xp    || 0);

      applyUserHeader();
    }

    function applyUserHeader(){
      const raw = currentUser?.displayName || currentUser?.email?.split('@')[0] || `ID-${currentUser?.uid?.slice(0,6)}`;
      $('userName').textContent = sanitizeUsername(raw);

      const parts=[];
      parts.push(`${balanceLabel}: ${balanceValue}`);
      if (userLevel) parts.push(`${LangManager.t('level','C·∫•p')}: ${userLevel}`);
      $('userStatsLine').textContent = parts.join(' ‚Ä¢ ');

      const wrap = $('balance-wrap');
      const bar  = $('balance-fill');
      const txt  = $('balance-text');
      if (wrap && bar && txt){
        wrap.style.display = 'flex';
        const quota = 100; // hi·ªÉn th·ªã ti·∫øn ƒë·ªô theo m·ªëc 100
        const pct = Math.max(0, Math.min(100, (balanceValue % quota) / quota * 100));
        bar.style.width = pct + '%';
        txt.textContent = `${LangManager.t('progress','Ti·∫øn ƒë·ªô')}: ${(balanceValue % quota)}/${quota} (${balanceLabel})`;
      }
    }

    // ========= Gift list (demo) =========
    const gifts = [
      { id:'g1', name:'Topping mi·ªÖn ph√≠', cost:50 },
      { id:'g2', name:'Gi·∫£m 20%', cost:100 },
      { id:'g3', name:'Combo n∆∞·ªõc', cost:150 },
      { id:'g4', name:'Voucher 50k', cost:200 },
      { id:'g5', name:'Th·∫ª qu√† t·∫∑ng 100k', cost:300 },
      { id:'g6', name:'Th·∫ª game 200k', cost:500 },
      { id:'g7', name:'Th·∫ª qu√† t·∫∑ng 500k', cost:1000 },
      { id:'g8', name:'Th·∫ª qu√† t·∫∑ng 1 tri·ªáu', cost:2000 },
      { id:'g9', name:'Th·∫ª qu√† t·∫∑ng 2 tri·ªáu', cost:5000 },
      { id:'g10', name:'Th·∫ª qu√† t·∫∑ng 5 tri·ªáu', cost:10000 },
      { id:'g11', name:'Th·∫ª qu√† t·∫∑ng 10 tri·ªáu', cost:20000 },
      { id:'g12', name:'Th·∫ª qu√† t·∫∑ng 20 tri·ªáu', cost:50000 }
    ];

    function renderGifts(){
      const box = $('gift-list'); box.innerHTML='';
      gifts.forEach(g=>{
        const card = document.createElement('div');
        card.className = 'card p-4 flex justify-between items-center';
        card.innerHTML = `
          <div>
            <div class="font-bold">${g.name}</div>
            <div class="muted text-sm">${LangManager.t('price','Gi√°')}: ${g.cost} ${balanceLabel.toLowerCase()}</div>
          </div>
          <button class="btn">${LangManager.t('redeemNow','ƒê·ªïi')}</button>
        `;
        card.querySelector('button').onclick = ()=> redeemGift(g);
        box.appendChild(card);
      });
    }

    // ========= Redeem flow =========
    async function redeemGift(gift){
      const u = auth.currentUser;
      if(!u){ toast(LangManager.t('needLoginTitle','C·∫ßn ƒëƒÉng nh·∫≠p'), LangManager.t('needLoginMsg','H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·ªïi qu√†.'),'error', ()=> location.href='login.html'); return; }

      // Ki·ªÉm tra ƒë·ªß s·ªë d∆∞ (points ho·∫∑c xp)
      if (balanceValue < gift.cost){
        const notEnough = LangManager.t('notEnough','Kh√¥ng ƒë·ªß {bal}').replace('{bal}', balanceLabel.toLowerCase());
        const needMsg = LangManager.t('needAmount','C·∫ßn {need} {bal}, hi·ªán c√≥ {have}.')
                         .replace('{need}', gift.cost)
                         .replace('{bal}', balanceLabel.toLowerCase())
                         .replace('{have}', balanceValue);
        toast(notEnough, needMsg, 'error');
        return;
      }

      try{
        const validDays = 7;
        const expiresAt = new Date(Date.now() + validDays*86400000);

        // T·∫°o voucher
        const ref = await db.collection('vouchers').add({
          ownerUid: u.uid,
          uid: u.uid,
          giftId: gift.id,
          giftName: gift.name,
          cost: gift.cost,
          status: 'active',
          validDays,
          issuedAt: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt)
        });
        const voucherId = ref.id;

        // Ghi log
        await db.collection('redeem_logs').add({
          uid: u.uid,
          voucherId,
          giftId: gift.id,
          giftName: gift.name,
          cost: gift.cost,
          redeemedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Tr·ª´ s·ªë d∆∞: n·∫øu c√≥ points ‚Üí tr·ª´ points; n·∫øu ƒëang d√πng XP ‚Üí tr·ª´ xp
        const userRef = db.collection('users').doc(u.uid);
        if (hasPointsField){
          const newPoints = Math.max(0, balanceValue - gift.cost);
          await userRef.set({ points: newPoints, last_voucher_id: voucherId }, { merge:true });
          balanceValue = newPoints;
        } else {
          const newXP = Math.max(0, balanceValue - gift.cost);
          await userRef.set({ xp: newXP, last_voucher_id: voucherId }, { merge:true });
          balanceValue = newXP;
        }

        // C·∫≠p nh·∫≠t UI header
        applyUserHeader();

        toast(LangManager.t('redeemSuccess','ƒê·ªïi th√†nh c√¥ng'), LangManager.t('voucherCreated','Voucher ƒë√£ ƒë∆∞·ª£c t·∫°o.'), 'success', ()=>{
          location.href = 'voucher.html?id=' + encodeURIComponent(voucherId);
        });
      }catch(e){
        console.error(e);
        toast(LangManager.t('error','L·ªói'), e.message || LangManager.t('redeemFail','Kh√¥ng th·ªÉ ƒë·ªïi qu√†.'), 'error');
      }
    }

    // ========= Auth =========
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u;
      renderGifts(); // render theo nh√£n ƒêi·ªÉm/XP hi·ªán th·ªùi (s·∫Ω c·∫≠p nh·∫≠t l·∫°i sau loadUserStats)
      if(u){
        await loadUserStats();
        renderGifts(); // re-render ƒë·ªÉ c·∫≠p nh·∫≠t nh√£n gi√° (ƒëi·ªÉm/xp)
      } else {
        $('userName').textContent = LangManager.t('guestName','Kh√°ch');
        $('userStatsLine').textContent = '';
        $('balance-wrap').style.display = 'none';
        balanceLabel=LangManager.t('points','ƒêi·ªÉm');
        balanceValue=0;
        renderGifts();
      }
    });
  </script>

  <!-- ThemeSync v3: ƒë·ªìng b·ªô theme theo t√†i kho·∫£n (gi·ªØ nguy√™n UI hi·ªán c√≥) -->
  <script>
  (function ThemeSyncV3(){
    const LS_KEY='voucher-theme';
    const root=document.documentElement;
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

    let current=null, uid=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){
      current=t;
      t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
      // icon & favicon
      const icon=document.getElementById('themeIcon');
      if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
      const fav=document.getElementById('favicon');
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      dispatchChange(t);
      if(bc) bc.postMessage({type:'theme-applied', theme:t});
    }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

    async function setRemoteTheme(t){
      if(!uid) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, {merge:true});
      }finally{
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    // API ƒë·ªÉ n√∫t b·∫•m g·ªçi
    window.ThemeManager={
      getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
      async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
    };
    document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

    // Sync ƒëa tab
    if(bc){
      bc.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
    }

    // √Åp theme ban ƒë·∫ßu (kh√°ch)
    applyTheme(getLocal() || getSystem());

    // Login ‚Üí ƒë·ªìng b·ªô theo t√†i kho·∫£n
    firebase.auth().onAuthStateChanged(async (user)=>{
      if(unsubUser){ unsubUser(); unsubUser=null; }
      uid = user?.uid || null;

      if(!uid){ applyTheme(getLocal() || getSystem()); return; }

      const userRef=firebase.firestore().collection('users').doc(uid);
      const snap=await userRef.get();
      let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

      if(!remoteTheme){
        remoteTheme = getLocal() || getSystem();
        applyTheme(remoteTheme);
        setLocal(remoteTheme);
        await setRemoteTheme(remoteTheme);
      }else{
        setLocal(remoteTheme);
        applyTheme(remoteTheme);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if(!s.exists) return;
        const t=s.data()?.prefs?.theme;
        if(!t) return;
        if(suppressNext) return;
        if(t!==current){ setLocal(t); applyTheme(t); }
      });
    });
  })();
  </script>

  <!-- LangSync: i18n Firestore + fallback -->
  <script>
  (function LangSync(){
    const LS_KEY = 'app-lang';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('lang-sync') : null;
    const sel = document.getElementById('langSelect');
    const dictCache = {};
    let current = null, uid = null, unsubUser = null, suppressNext = false;

    const fallback = {
      vi: {
        titlePage:'ƒê·ªïi qu√†',
        redeemTitle:'ƒê·ªïi qu√†',
        subTitle:'Ch·ªçn qu√† ƒë·ªÉ ƒë·ªïi',
        library:'Th∆∞ vi·ªán',
        guestName:'Kh√°ch',
        points:'ƒêi·ªÉm',
        level:'C·∫•p',
        progress:'Ti·∫øn ƒë·ªô',
        listTitle:'Danh s√°ch qu√†',
        price:'Gi√°',
        redeemNow:'ƒê·ªïi',
        needLoginTitle:'C·∫ßn ƒëƒÉng nh·∫≠p',
        needLoginMsg:'H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·ªïi qu√†.',
        notEnough:'Kh√¥ng ƒë·ªß {bal}',
        needAmount:'C·∫ßn {need} {bal}, hi·ªán c√≥ {have}.',
        redeemSuccess:'ƒê·ªïi th√†nh c√¥ng',
        voucherCreated:'Voucher ƒë√£ ƒë∆∞·ª£c t·∫°o.',
        error:'L·ªói',
        redeemFail:'Kh√¥ng th·ªÉ ƒë·ªïi qu√†.'
      },
      en: {
        titlePage:'Redeem',
        redeemTitle:'Redeem',
        subTitle:'Choose a reward to redeem',
        library:'Library',
        guestName:'Guest',
        points:'Points',
        level:'Level',
        progress:'Progress',
        listTitle:'Rewards list',
        price:'Price',
        redeemNow:'Redeem',
        needLoginTitle:'Sign in required',
        needLoginMsg:'Please sign in before redeeming.',
        notEnough:'Not enough {bal}',
        needAmount:'Need {need} {bal}, you have {have}.',
        redeemSuccess:'Redeemed successfully',
        voucherCreated:'Voucher has been created.',
        error:'Error',
        redeemFail:'Could not redeem.'
      }
    };

    function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(v){ try{ localStorage.setItem(LS_KEY, v) }catch{} }

    async function loadDict(lang){
      if (dictCache[lang]) return dictCache[lang];
      try{
        const snap = await db.collection('i18n').doc(lang).get();
        if (snap.exists){ dictCache[lang] = { ...fallback[lang], ...(snap.data()||{}) }; return dictCache[lang]; }
      }catch(e){}
      dictCache[lang] = fallback[lang] || {}; return dictCache[lang];
    }

    function applyDict(dict){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (k && dict[k] != null) el.textContent = dict[k];
      });
      if (dict.titlePage) document.title = dict.titlePage;
    }

    async function applyLang(lang){
      current = lang; if (sel) sel.value = lang; setLocal(lang);
      const dict = await loadDict(lang); window.__i18n = dict; applyDict(dict);
      if (bc) bc.postMessage({ type:'lang-applied', lang });
      try{ window.dispatchEvent(new CustomEvent('langchange', { detail:{ lang } })); }catch{}
    }

    window.LangManager = {
      get(){ return current || getLocal() || sys(); },
      async set(lang){ if (!lang) return; await applyLang(lang); },
      t(k, fb){ const d = window.__i18n || {}; return (d[k] != null ? d[k] : (fb||'')); }
    };

    sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

    (async ()=>{ const initial = getLocal() || sys(); await applyLang(initial); })();

    // ƒê·ªìng b·ªô theo t√†i kho·∫£n
    auth.onAuthStateChanged(async (user)=>{
      if (unsubUser){ unsubUser(); unsubUser = null; }
      uid = user?.uid || null;

      if (!uid){ const lang = getLocal() || sys(); await applyLang(lang); return; }

      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();
      let remoteLang = snap.exists ? (snap.data()?.prefs?.lang || null) : null;

      if (!remoteLang){
        remoteLang = getLocal() || sys();
        await applyLang(remoteLang);
        try{ await userRef.set({ prefs:{ lang:remoteLang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true }); }catch{}
      } else {
        setLocal(remoteLang);
        await applyLang(remoteLang);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if (!s.exists) return;
        const v = s.data()?.prefs?.lang; if (!v) return;
        if (suppressNext) return;
        if (v !== current){ setLocal(v); applyLang(v); }
      });
    });

    // Sync ƒëa tab
    if (bc){
      bc.onmessage = (ev)=>{
        if (ev?.data?.type === 'lang-applied'){
          const lang = ev.data.lang; if (lang && lang !== current) applyLang(lang);
        }
      };
    }
  })();
  </script>

  <script>
    // ========= Theme icon =========
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
      themeIcon.src = window.ThemeManager.getTheme() === 'dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg';
      themeIcon.alt = window.ThemeManager.getTheme() === 'dark' ? 'Dark Mode' : 'Light Mode';
    }
  </script>
</body>
</html>
