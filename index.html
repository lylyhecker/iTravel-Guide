<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iTravel Guide</title>
  <meta name="description" content="iTravel Guide - Cẩm nang du lịch, gợi ý địa điểm hấp dẫn, trải nghiệm thú vị." />

  <!-- Favicon theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    body{margin:0; color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%), var(--bg);} 
    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; text-decoration:none; }
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block;vertical-align:-0.2em}
    .icon.themable{ filter:none; transition:filter .2s ease; }
    :root[data-theme="dark"] img.icon.themable{ filter: invert(1) brightness(1.1) contrast(1.05); }

    #map{height: 360px}
    @media (min-width: 1024px){ #map{height: calc(100vh - 200px);} }

    .badge{border:1px solid var(--border); background:var(--bg-soft); border-radius:12px; padding:6px 10px}
    .hl-sent{background:rgba(250,204,21,.35);border-radius:.3em;padding:0 .15em;transition:background .2s ease}

    /* Quiz UI */
    .quiz-card { background: var(--bg-soft); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .quiz-choice { display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; user-select:none;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .quiz-choice:hover { transform: translateY(-1px); }
    .quiz-choice.correct { background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.4); }
    .quiz-choice.wrong   { background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.4); }
    .quiz-progress { height:8px; border-radius:999px; background:var(--bg-soft); overflow:hidden; border:1px solid var(--border); }
    .quiz-progress > div { height:100%; background:var(--primary); width:0%; transition:width .25s ease; }
    .quiz-badge { font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:var(--bg-soft); }
    .quiz-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .quiz-stats { display:flex; gap:10px; align-items:center; font-size:14px; color: var(--muted); }
    .quiz-explain { font-size:14px; color: var(--muted); border-left:3px solid var(--border); padding-left:10px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="px-4 lg:px-8 py-4 flex items-center justify-between">
    <!-- Logo -->
    <div class="flex items-center gap-3">
      <img src="assets/location.svg" class="icon themable" alt="pin" />
      <h1 class="text-xl lg:text-2xl font-semibold">iTravel Guide</h1>
    </div>

    <!-- Right: User + XP + Actions -->
    <div class="flex items-center gap-4">
      <!-- User + XP -->
      <div class="flex flex-col items-end gap-1">
        <span id="userName" class="text-sm font-medium"></span>
        <div class="flex items-center gap-2">
          <div id="xp-bar-container"
              class="h-[8px] w-[160px] rounded-full overflow-hidden border"
              style="background:var(--bg-soft); border-color:var(--border)">
            <div id="xp-bar-fill" class="h-full"
                style="width:0%; background:linear-gradient(90deg, var(--primary), #60a5fa); transition:width .35s ease"></div>
          </div>
          <span id="xp-label" class="text-xs text-[color:var(--muted)]">Lv 1 · 0/100</span>
        </div>
      </div>

      <!-- Voucher -->
      <a href="voucher.html" class="btn secondary">
        <img src="assets/ticket.svg" class="icon themable" alt=""> <span data-i18n="voucher">Voucher</span>
      </a>

      <!-- Theme -->
      <button class="btn secondary" id="themeBtn" title="Đổi giao diện">
        <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
      </button>

      <!-- Language -->
      <select id="langSelect" class="btn secondary" title="Language">
        <option value="vi">🇻🇳 VI</option>
        <option value="en">🇬🇧 EN</option>
      </select>

      <!-- Auth -->
      <button class="btn secondary" id="loginBtn" title="Đăng nhập">
        <img src="assets/user.svg" class="icon themable" alt=""> <span data-i18n="login">Đăng nhập</span>
      </button>
      <button class="btn secondary hidden" id="logoutBtn" title="Đăng xuất">
        <img src="assets/exit.svg" class="icon themable" alt=""> <span data-i18n="logout">Đăng xuất</span>
      </button>
    </div>
  </header>



  <!-- Main -->
  <main class="px-4 lg:px-8 pb-10 grid lg:grid-cols-2 gap-6">
    <!-- LEFT -->
    <section class="card p-4 lg:p-6">
      <div class="flex flex-col lg:flex-row lg:items-end gap-3 mb-4">
        <div class="flex-1">
          <label class="text-sm text-[color:var(--muted)]" data-i18n="choosePlace">Chọn địa điểm</label>
          <select id="placeSelect" class="w-full mt-1 bg-transparent border rounded-lg px-3 py-2" style="border-color:var(--border)"></select>
        </div>
        <div class="flex gap-2">
          <button id="centerBtn" class="btn secondary"><img src="assets/target.svg" class="icon themable" alt=""> <span data-i18n="centerMap">Đưa bản đồ tới điểm</span></button>
          <button id="locateBtn" class="btn secondary"><img src="assets/gps.svg" class="icon themable" alt=""> <span data-i18n="myLocation">Vị trí của tôi</span></button>
        </div>
      </div>
      <div id="map" class="rounded-xl overflow-hidden"></div>
      <div class="flex items-center gap-3 mt-4">
        <span class="text-sm text-[color:var(--muted)]" data-i18n="distanceTo">Khoảng cách tới điểm:</span>
        <strong id="distance">—</strong>
        <label class="ml-auto flex items-center gap-2 text-sm">
          <input id="autoplay" type="checkbox" class="scale-125"> <span data-i18n="autoplayNear">Tự phát khi ≤100m</span>
        </label>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card p-4 lg:p-6 flex flex-col gap-4">
      <div>
        <h2 id="placeTitle" class="text-2xl font-semibold"></h2>
        <p class="text-sm text-[color:var(--muted)] mt-1" data-i18n="subtitle">Thuyết minh | Quiz (AI) | Map</p>
      </div>
      <div class="space-y-3">
        <div class="text-sm text-[color:var(--muted)]" data-i18n="introQuick">Giới thiệu nhanh</div>
        <p id="intro" class="leading-relaxed"></p>
      </div>
      <div class="grid sm:grid-cols-2 gap-3">
        <button id="aiReadBtn" class="btn"><img src="assets/volume.svg" alt="" class="icon themable"> <span data-i18n="tts">Máy đọc thuyết minh</span></button>
        <button id="stopReadBtn" class="btn secondary"><img src="assets/stop.svg" alt="" class="icon themable"> <span data-i18n="stop">Dừng đọc</span></button>
      </div>
      <div class="border-t border-dashed" style="border-color:var(--border)"></div>
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
        <div>
          <div class="font-medium" data-i18n="quizTitle">Trắc nghiệm AI</div>
          <div class="text-sm text-[color:var(--muted)]" data-i18n="quizHint">Luôn gắn với địa điểm đang chọn, tránh lặp câu</div>
        </div>
        <div class="quiz-actions">
          <button id="startQuiz" class="btn"><img src="assets/play.svg" alt="" class="icon themable"> <span data-i18n="createQuestion">Tạo câu hỏi</span></button>
          <button id="endQuiz" class="btn secondary"><img src="assets/stop.svg" alt="" class="icon themable"> <span data-i18n="end">Kết thúc</span></button>
        </div>
      </div>
      <div id="quizBox" class="hidden mt-2">
        <div class="quiz-card">
          <div class="quiz-progress"><div id="qprog"></div></div>
          <div id="qwrap" class="mt-3"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  /* ===================== Firebase init ===================== */
  const firebaseConfig={
    apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
    authDomain:"loginandsignin-4932b.firebaseapp.com",
    projectId:"loginandsignin-4932b",
    storageBucket:"loginandsignin-4932b.appspot.com",
    messagingSenderId:"863133586719",
    appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"
  };
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();

  /* ===================== Auth UI ===================== */
  function gotoLogin(){
    const ret = encodeURIComponent(location.href);
    location.href = `login.html?returnTo=${ret}`;
  }
  function updateAuthUI(u){
    document.getElementById('loginBtn').classList.toggle('hidden', !!u);
    document.getElementById('logoutBtn').classList.toggle('hidden', !u);
  }

  /* ThemeSync v3: đồng bộ theme theo tài khoản (giữ nguyên UI hiện có) */
    (function ThemeSyncV3(){
    const LS_KEY='voucher-theme';
    const root=document.documentElement;
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

    let current=null, uid=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){
      current=t;
      t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
      // icon & favicon
      const icon=document.getElementById('themeIcon');
      if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
      const fav=document.getElementById('favicon');
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      dispatchChange(t);
      if(bc) bc.postMessage({type:'theme-applied', theme:t});
    }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

    async function setRemoteTheme(t){
      if(!uid) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, {merge:true});
      }finally{
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    // API để nút bấm gọi
    window.ThemeManager={
      getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
      async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
    };
    document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

    // Sync đa tab
    if(bc){
      bc.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
    }

    // Áp theme ban đầu (khách)
    applyTheme(getLocal() || getSystem());

    // Login → đồng bộ theo tài khoản
    firebase.auth().onAuthStateChanged(async (user)=>{
      if(unsubUser){ unsubUser(); unsubUser=null; }
      uid = user?.uid || null;

      if(!uid){ applyTheme(getLocal() || getSystem()); return; }

      const userRef=firebase.firestore().collection('users').doc(uid);
      const snap=await userRef.get();
      let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

      if(!remoteTheme){
        remoteTheme = getLocal() || getSystem();
        applyTheme(remoteTheme);
        setLocal(remoteTheme);
        await setRemoteTheme(remoteTheme);
      }else{
        setLocal(remoteTheme);
        applyTheme(remoteTheme);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if(!s.exists) return;
        const t=s.data()?.prefs?.theme;
        if(!t) return;
        if(suppressNext) return;
        if(t!==current){ setLocal(t); applyTheme(t); }
      });
    });
  })();

  /* ===================== LangSync (Firebase i18n) ===================== */
  (function LangSync(){
    const LS_KEY_LANG = 'app-lang';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('lang-sync') : null;
    const langSelect = document.getElementById('langSelect');

    let uid = null, currentLang = null, unsubUser = null, suppressNext = false;
    let dictCache = {}; // { lang: {key: value} }

    function getSystemLang(){
      const n = (navigator.language || 'vi').toLowerCase();
      if (n.startsWith('vi')) return 'vi';
      return 'en';
    }
    function getLocalLang(){ try{return localStorage.getItem(LS_KEY_LANG)}catch{return null} }
    function setLocalLang(v){ try{ localStorage.setItem(LS_KEY_LANG, v) }catch{} }

    function applyI18nDict(dict){
      if(!dict) return;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (key && dict[key]!=null) el.textContent = dict[key];
      });
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      if (loginBtn && dict.login) loginBtn.title = dict.login;
      if (logoutBtn && dict.logout) logoutBtn.title = dict.logout;
    }

    async function loadDict(lang){
      if (dictCache[lang]) return dictCache[lang];
      try{
        const snap = await db.collection('i18n').doc(lang).get();
        if (snap.exists){
          dictCache[lang] = snap.data() || {};
          return dictCache[lang];
        }
      }catch(e){ console.warn('i18n load error', e); }
      dictCache[lang] = {}; // fallback
      return dictCache[lang];
    }

    async function setRemoteLang(lang){
      if(!uid) return;
      suppressNext = true;
      try{
        await db.collection('users').doc(uid).set({
          prefs: { lang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, { merge: true });
      } finally {
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    async function applyLang(lang){
      currentLang = lang;
      if (langSelect) langSelect.value = lang;
      setLocalLang(lang);
      const dict = await loadDict(lang);
      window.__i18n = dict; // expose
      applyI18nDict(dict);
      if (bc) bc.postMessage({type:'lang-applied', lang});
      try{ window.dispatchEvent(new CustomEvent('langchange', {detail:{lang}})); }catch{}
    }

    window.LangManager = {
      get(){ return currentLang || getLocalLang() || getSystemLang(); },
      async set(lang){ if (!lang) return; await applyLang(lang); await setRemoteLang(lang); },
      t(key, fallback){ return (window.__i18n && window.__i18n[key]!=null) ? window.__i18n[key] : (fallback||''); }
    };

    langSelect?.addEventListener('change', (e)=>{ window.LangManager.set(e.target.value); });

    if (bc){
      bc.onmessage = (ev)=>{
        if (ev?.data?.type === 'lang-applied'){
          const lang = ev.data.lang;
          if (lang && lang !== currentLang){ applyLang(lang); }
        }
      };
    }

    (async ()=>{ const initial = getLocalLang() || getSystemLang(); await applyLang(initial); })();

    auth.onAuthStateChanged(async (user)=>{
      if (unsubUser){ unsubUser(); unsubUser = null; }
      uid = user?.uid || null;

      if (!uid){ const lang = getLocalLang() || getSystemLang(); await applyLang(lang); return; }

      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();
      let remoteLang = snap.exists ? (snap.data()?.prefs?.lang || null) : null;

      if (!remoteLang){
        remoteLang = getLocalLang() || getSystemLang();
        await applyLang(remoteLang);
        await setRemoteLang(remoteLang);
      } else {
        setLocalLang(remoteLang);
        await applyLang(remoteLang);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if (!s.exists) return;
        const v = s.data()?.prefs?.lang;
        if (!v) return;
        if (suppressNext) return;
        if (v !== currentLang){ setLocalLang(v); applyLang(v); }
      });
    });
  })();

  /* ===================== Map + Places (Huế) ===================== */
  const DATA_INDEX_URL='data/places.json';
  let PLACES=[], currentPlace=null, currentReadText='';
  let map, userMarker, placeMarkers={}, watchingId=null, withinPlayed=false;

  const $ = (sel)=> document.querySelector(sel);
  const fmtDist = (m)=> !isFinite(m)?'—': (m<1000? `${Math.round(m)} m`: `${(m/1000).toFixed(2)} km`);
  const haversine=(a,b)=>{ const R=6371000, toRad=d=>d*Math.PI/180;
    const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]), lat1=toRad(a[0]), lat2=toRad(b[0]);
    const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(h));
  };

  async function loadPlaces(){
    try{
      const r=await fetch(DATA_INDEX_URL, {cache:'no-store'});
      if(!r.ok) throw 0;
      PLACES=await r.json();
    }catch(e){
      console.warn('Không tải được data/places.json. Fallback 1 điểm.');
      PLACES=[{id:'dai-noi-hue',name:'Đại Nội Huế',coords:[16.46974,107.57969],read_url:'',quiz_url:''}];
    }
    const sel=$('#placeSelect'); sel.innerHTML='';
    PLACES.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
    currentPlace = PLACES.find(p=>p.id==='dai-noi-hue') || PLACES[0] || null;
    if(currentPlace) sel.value=currentPlace.id;
  }
  async function loadReadForCurrent() {
    // GUARD: chưa có currentPlace thì xóa intro và thoát
    if (!currentPlace) {
      const introEl = document.getElementById('intro');
      if (introEl) introEl.textContent = '';
      return;
    }

    currentReadText = '';
    const lang = LangManager.get();

    // Dùng optional chaining để không đụng null
    const url = (lang === 'en' && currentPlace?.read_url_en)
                  ? currentPlace.read_url_en
                  : currentPlace?.read_url;

    if (url) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        currentReadText = await r.text();
      } catch (e) {}
    }
    if (!currentReadText) {
      currentReadText = (lang === 'en' ? currentPlace?.intro_en : currentPlace?.intro) || '';
    }
    document.getElementById('intro').textContent = currentReadText;
  }


  function initMap(){
    map=L.map('map').setView([16.46974,107.57969],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    rebuildMarkers();
  }
  function rebuildMarkers(){
    Object.values(placeMarkers).forEach(m=> m.remove && m.remove()); placeMarkers={};
    const latlngs=[]; PLACES.forEach(p=>{ const m=L.marker(p.coords).addTo(map).bindPopup(p.name);
      m.on('click',()=> selectPlace(p.id)); placeMarkers[p.id]=m; latlngs.push(p.coords);
    });
    if(latlngs.length){ const b=L.latLngBounds(latlngs); map.fitBounds(b,{maxZoom:16,padding:[20,20]}); }
  }
  function selectPlace(id){
    currentPlace=PLACES.find(p=>p.id===id)||PLACES[0];
    $('#placeSelect').value=currentPlace.id;
    withinPlayed=false;
    // reset quiz khi đổi điểm
    qIdx=0; qScore=0; qGained=0;
    $('#quizBox').classList.add('hidden'); const qwrap=$('#qwrap'); if(qwrap) qwrap.innerHTML='';
    setProg();
    renderPlace();
  }
  async function renderPlace(){
    if (!currentPlace) {  // GUARD
      $('#placeTitle').textContent = '';
      $('#intro').textContent = '';
      return;
    }
    const lang = LangManager.get();
    const title = (lang === 'en' && currentPlace?.name_en) ? currentPlace.name_en : (currentPlace?.name || '');
    $('#placeTitle').textContent = title;
    await loadReadForCurrent();
    if (map && currentPlace?.coords) map.setView(currentPlace.coords, 16);
    placeMarkers[currentPlace.id]?.openPopup?.();
  }


  function startGeowatch(){
    // === Utils nhanh ===
const R = 6371000; // bán kính Trái Đất (m)
const toRad = d => d * Math.PI / 180;

// Equirectangular: đủ chính xác < ~50 km, nhanh hơn Haversine
function fastDistanceMeters(a, b) {
  const [lat1, lon1] = a, [lat2, lon2] = b;
  const φm = toRad((lat1 + lat2) / 2);
  const x = toRad(lon2 - lon1) * Math.cos(φm);
  const y = toRad(lat2 - lat1);
  return Math.sqrt(x*x + y*y) * R;
}

// Batch DOM update
let rafPending = false;
function raf(fn) {
  if (rafPending) return;
  rafPending = true;
  requestAnimationFrame(() => { rafPending = false; fn(); });
}

function startGeowatch() {
  // === Helpers cục bộ, tránh đụng tên global ===
  const R = 6371000; // m
  const toRad = d => d * Math.PI / 180;
  // equirectangular nhanh (đủ tốt <~50km)
  const fastDistanceMeters = (a, b) => {
    const [lat1, lon1] = a, [lat2, lon2] = b;
    const φm = toRad((lat1 + lat2) / 2);
    const x = toRad(lon2 - lon1) * Math.cos(φm);
    const y = toRad(lat2 - lat1);
    return Math.sqrt(x*x + y*y) * R;
  };
  const $get = sel => document.querySelector(sel);
  const distEl = document.getElementById('distance') || $get('#distance');

  // Fallback nếu thiếu fmtDist
  const fmtDistSafe = (d) => {
    if (typeof fmtDist === 'function') return fmtDist(d);
    // fallback đơn giản
    if (d >= 1000) return (d/1000).toFixed(2) + ' km';
    return Math.round(d) + ' m';
  };

  // Tránh update quá dày
  const UPDATE_EVERY_MS = 600;
  const MIN_MOVE_M = 5;
  const MIN_DELTA_DIST_M = 1;

  let lastTick = 0;
  let lastPos = null;
  let lastDist = null;

  // Dọn watch cũ (nếu bạn có biến watchingId global)
  try { if (typeof watchingId !== 'undefined' && watchingId) {
    navigator.geolocation.clearWatch(watchingId);
    watchingId = null;
  }} catch {}

  function safeSetUserMarker(here) {
    try {
      if (!map) return;
      if (!window.userMarker) {
        window.userMarker = L.circleMarker(here, { radius: 8, color: '#4ade80' })
          .addTo(map).bindPopup('Bạn đang ở đây');
      } else {
        window.userMarker.setLatLng(here);
      }
    } catch(e) { /* bỏ qua */ }
  }

  function applyHere(here) {
    safeSetUserMarker(here);

    // Guard: chưa có điểm hiện tại
    const coords = (typeof currentPlace === 'object' && Array.isArray(currentPlace?.coords))
      ? currentPlace.coords
      : null;
    if (!coords) {
      if (distEl) distEl.textContent = '—';
      return;
    }

    // Bỏ qua nhiễu di chuyển nhỏ
    if (lastPos && fastDistanceMeters(here, lastPos) < MIN_MOVE_M) return;

    const dist = fastDistanceMeters(here, coords);

    // Chỉ cập nhật DOM khi khác đáng kể
    if (lastDist === null || Math.abs(dist - lastDist) >= MIN_DELTA_DIST_M) {
      if (distEl) distEl.textContent = fmtDistSafe(dist);
      lastDist = dist;
    }
    lastPos = here;
  }

  function onPosition(pos) {
    const now = performance.now ? performance.now() : Date.now();
    if (document.visibilityState && document.visibilityState !== 'visible') return;
    if (now - lastTick < UPDATE_EVERY_MS) return;
    lastTick = now;

    const here = [pos.coords.latitude, pos.coords.longitude];
    applyHere(here);
  }

  // Lấy nhanh vị trí cache để hiển thị tức thì (không lỗi cũng không sao)
  try {
    navigator.geolocation.getCurrentPosition(
      p => onPosition(p),
      () => {},
      { enableHighAccuracy: false, maximumAge: 300000, timeout: 2000 }
    );
  } catch {}

  // Bắt đầu watch
  try {
    window.watchingId = navigator.geolocation.watchPosition(
      onPosition,
      err => console.warn('watchPosition error', err),
      { enableHighAccuracy: false, maximumAge: 10000, timeout: 5000 }
    );
  } catch(e) {
    console.warn('startGeowatch failed:', e);
  }
}
  }


  /* ===================== Reading + Highlight ===================== */
  function getVoiceByLang(target){
    const vs = speechSynthesis.getVoices();
    return vs.find(v => (v.lang||'').toLowerCase().startsWith(target))
        || vs.find(v => new RegExp(target.split('-')[0],'i').test(v.lang||v.name))
        || vs[0];
  }
  
  function aiRead(){
    const lang = LangManager.get();
    const introEl = $('#intro');
    const text = ((currentPlace?.name? currentPlace.name+'. ' : '') + (currentReadText||'')).replace(/\s+/g,' ').trim();
    const sentences = text.split(/(?<=[\.\!\?…])\s+/);
    if(introEl){ introEl.innerHTML=''; const c=document.createElement('span'); sentences.forEach((s,i)=>{ const sp=document.createElement('span'); sp.textContent=(i?' ':'')+s; sp.dataset.idx=i; c.appendChild(sp); }); introEl.appendChild(c); }
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = (lang === 'en' ? 'en-US' : 'vi-VN');
    const v = getVoiceByLang(u.lang.toLowerCase());
    if(v) u.voice = v;
    const offsets=[]; let acc=0; sentences.forEach((s,i)=>{ offsets.push(acc); acc+=(i?1:0)+s.length; });
    function hi(x){ if(!introEl) return; let k=0; for(let i=0;i<offsets.length;i++){ if(offsets[i]<=x) k=i; } introEl.querySelectorAll('span').forEach(el=> el.classList.toggle('hl-sent', Number(el.dataset.idx)===k)); }
    u.onboundary=(e)=>{ if(e.charIndex!=null) hi(e.charIndex||0); };
    u.onstart=()=>hi(0);
    u.onend=()=> introEl?.querySelectorAll('span').forEach(el=> el.classList.remove('hl-sent'));
    speechSynthesis.speak(u);
  }

  function stopRead(){ try{ speechSynthesis.cancel(); }catch{} }

  /* ===================== Quiz AI: tránh lặp + bám địa điểm ===================== */

  // DÙNG PROXY — KHÔNG CÒN KEY TRÊN CLIENT
  window.AI_PROXY_URL = window.AI_PROXY_URL || 'https://itravel-guide.baovagiao.workers.dev/gemini';
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function callGemini(messages) {
    const prompt = messages.map(m => `${m.role}: ${m.content}`).join("\n");
    const models = ["gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.5-pro"];
    const retriable = new Set([429,500,502,503,504]);
    const maxRetries = 4;

    for (let mi = 0; mi < models.length; mi++){
      const model = models[mi];
      for (let attempt = 0; attempt < maxRetries; attempt++){
        try {
          const endpoint = window.AI_PROXY_URL;
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ role: "user", parts: [{ text: prompt }] }],
              generationConfig: { temperature:0.7, topK:40, topP:0.95, maxOutputTokens:1024 }
            })
          });
          if (!res.ok){
            let serverMsg=""; try{ const d=await res.json(); serverMsg=d?.error?.message?`: ${d.error.message}`:""; }catch{}
            if (retriable.has(res.status) && attempt < maxRetries-1){
              const delay=Math.pow(2,attempt)*200 + Math.floor(Math.random()*120);
              await sleep(delay); continue;
            }
            if (mi < models.length-1) break; // thử model tiếp theo
            throw new Error(`Lỗi API (${res.status})${serverMsg}`);
          }
          const data = await res.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
          if (!text.trim()) throw new Error("Phản hồi trống.");
          return text;
        } catch (err){
          if (attempt < maxRetries-1){
            const delay=Math.pow(2,attempt)*200 + Math.floor(Math.random()*120);
            await sleep(delay); continue;
          }
          if (mi < models.length-1) break;
        }
      }
    }
    return "Hiện mô hình đang quá tải. Hãy thử lại sau ít giây.";
  }

  async function callAI(messages){ return await callGemini(messages); }

  let quizSeed=null, seedLoadedFor=null;
  async function loadQuizSeedIfAny(){
    if(!currentPlace) return;
    if(seedLoadedFor === currentPlace.id) return;
    seedLoadedFor = currentPlace.id;
    quizSeed=null;
    if(currentPlace.quiz_url){
      try{ const r=await fetch(currentPlace.quiz_url,{cache:'no-store'}); if(r.ok) quizSeed=await r.json(); }catch{}
    }
  }

  const QUIZ_MEMORY = new Map(); // { placeId => Set(normalizedQuestion) }
  function normalizeQ(q){ return String(q||'').toLowerCase().replace(/\s+/g,' ').replace(/[“”"'.?!:,;()\[\]]/g,'').trim(); }
  function rememberQuestion(placeId, q){
    const key = placeId || '_global';
    if(!QUIZ_MEMORY.has(key)) QUIZ_MEMORY.set(key, new Set());
    const s = QUIZ_MEMORY.get(key);
    s.add(normalizeQ(q));
    if(s.size > 30){ const first = s.values().next().value; s.delete(first); }
  }
  function hasSeenQuestion(placeId, q){
    const key = placeId || '_global';
    const s = QUIZ_MEMORY.get(key);
    if(!s) return false;
    return s.has(normalizeQ(q));
  }

  function getPlaceContext(){
    const name = currentPlace?.name || '';
    const intro = (currentReadText || '').replace(/\s+/g,' ').trim().slice(0, 1000);
    const coords = Array.isArray(currentPlace?.coords) ? `(${currentPlace.coords[0]}, ${currentPlace.coords[1]})` : '';
    return { name, intro, coords };
  }
  function buildAvoidList(){
    const seen = QUIZ_MEMORY.get(currentPlace?.id || '_global');
    if(!seen || !seen.size) return '';
    return Array.from(seen).slice(-6).map(q=>`- ${q}`).join('\n');
  }
  function buildSeedSnippet(){
    if(!Array.isArray(quizSeed) || !quizSeed.length) return '';
    const sample = quizSeed.slice(0,2).map((it, idx)=>{
      const letters=['A','B','C','D'];
      const lines=(it.choices||[]).slice(0,3).map((c,i)=> `${letters[i]}. ${c}`).join('\n');
      const ans = typeof it.answer==='number' ? letters[it.answer] : 'A';
      return `Ví dụ ${idx+1}:
${it.q}
${lines}
Đáp án đúng: ${ans}
Giải thích: ${it.explain||''}`;
    }).join('\n\n');
    return sample;
  }
  function buildQuizMessages(){
    const ctx = getPlaceContext();
    const avoid = buildAvoidList();
    const lang = LangManager.get();

    const placeHint = (lang==='en'
      ? (ctx.name ? `PLACE: ${ctx.name} ${ctx.coords?ctx.coords:''}` : '')
      : (ctx.name ? `ĐỊA ĐIỂM: ${ctx.name} ${ctx.coords?ctx.coords:''}` : '')
    );

    const facts = ctx.intro
      ? (lang==='en' ? `SUMMARY:\n${ctx.intro}\n` : `TÓM TẮT THUYẾT MINH:\n${ctx.intro}\n`)
      : '';

    const avoidBlk = avoid
      ? (lang==='en'
          ? `DO NOT REPEAT recently shown questions:\n${avoid}\n`
          : `KHÔNG ĐƯỢC LẶP LẠI các câu gần đây:\n${avoid}\n`
        )
      : '';

    const userPrompt = (lang === 'en' ? `
${placeHint}
${facts}

REQUIREMENTS:
- Create ONE NEW MULTIPLE-CHOICE QUESTION directly related to the place above (history/architecture/culture...).
- The content must be ACCURATE, concise, in ENGLISH, not political/sensitive.
- Do NOT repeat or paraphrase recent questions.
${avoidBlk}

OUTPUT FORMAT (EXACTLY):
[Clear question, 1–2 lines]
A. [Choice A]
B. [Choice B]
C. [Choice C]
Correct answer: [A/B/C]
Explanation: [Short, correct explanation]
` : `
${placeHint}
${facts}

YÊU CẦU:
- Tạo 01 câu hỏi TRẮC NGHIỆM MỚI, LIÊN QUAN TRỰC TIẾP tới địa điểm trên (lịch sử/kiến trúc/văn hoá...).
- Nội dung CHÍNH XÁC, ngắn gọn, bằng TIẾNG VIỆT, không chính trị/nhạy cảm.
- KHÔNG trùng/paraphrase các câu đã xuất gần đây.
${avoidBlk}

ĐỊNH DẠNG TRẢ VỀ (Y HỆT):
[Câu hỏi rõ ràng, 1–2 dòng]
A. [Lựa chọn A]
B. [Lựa chọn B]
C. [Lựa chọn C]
Đáp án đúng: [A/B/C]
Giải thích: [Giải thích ngắn gọn, chính xác]
`).trim();

    return [
      { role:'system', content:(lang==='en'
          ? 'You are a quiz assistant for tourists in Hue. Respond ONLY in English following the exact format.'
          : 'Bạn là trợ lý tạo quiz cho du khách ở Huế. Chỉ trả về đúng định dạng yêu cầu. Không thêm thừa.'
        )
      },
      { role:'user', content: userPrompt }
    ];
  }

  function parseAIQuestion(output){
    if(!output) return null;
    const lines = output.split('\n').map(l=>l.trim()).filter(Boolean);
    const options = lines.filter(l => /^[ABC][.:、]/i.test(l));
    const correctLine = lines.find(l =>
      l.toLowerCase().startsWith('đáp án đúng') ||
      l.toLowerCase().startsWith('correct answer')
    );
    const explainLine = lines.find(l =>
      l.toLowerCase().startsWith('giải thích') ||
      l.toLowerCase().startsWith('explanation')
    );
    const question = lines.find(l =>
      !/^[ABC][.:、]/i.test(l) &&
      !l.toLowerCase().startsWith('đáp án đúng') &&
      !l.toLowerCase().startsWith('giải thích')
    );
    if(!question || options.length < 3 || !correctLine || !explainLine) return null;
    const correctAnswer = (correctLine.split(':')[1] || '').trim().charAt(0).toUpperCase();
    const explanation = (explainLine.split(':')[1] || '').trim();
    return { question, options, correctAnswer, explanation };
  }

  let qIdx=0, qScore=0, qGained=0;
  function perPoints(){ return 5; }
  function setProg(){ const p=document.getElementById('qprog'); if(!p) return; const pct=Math.round((qIdx/10)*100); p.style.width=pct+'%'; }

  async function renderQuiz(){
    if(!currentPlace){ alert(window.LangManager.t('selectAPlace','Hãy chọn địa điểm.')); return; }
    await loadQuizSeedIfAny();

    const box=document.getElementById('quizBox'); box.classList.remove('hidden');
    const wrap=document.getElementById('qwrap'); setProg();
    wrap.innerHTML = `<div class="text-sm text-[color:var(--muted)]">${window.LangManager.t('creatingQuestionFor','Đang tạo câu hỏi cho')} <b>${currentPlace.name}</b>…</div>`;

    const MAX_TRY=3;
    let parsed=null;
    for(let attempt=1; attempt<=MAX_TRY; attempt++){
      const messages = buildQuizMessages();
      const output = await callAI(messages).catch(()=> '');
      parsed = parseAIQuestion(output);
      if(parsed && !hasSeenQuestion(currentPlace.id, parsed.question)) break;
      if(attempt===MAX_TRY && parsed) break; // dùng tạm
    }
    if(!parsed){ wrap.innerHTML=`<div class="text-red-400">${window.LangManager.t('createQuestionFailure','Không tạo được câu phù hợp. Thử lại.')}</div>`; return; }

    rememberQuestion(currentPlace.id, parsed.question);

    const {question, options, correctAnswer, explanation} = parsed;
    wrap.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="quiz-stats">
          <span class="quiz-badge">${window.LangManager.t('placeBadgeLabel','Địa điểm:')} ${currentPlace.name}</span>
          <span class="quiz-badge">${window.LangManager.t('questionCount','Câu')} ${qIdx+1}/10</span>
          <span>${window.LangManager.t('correctNow','Đúng hiện tại:')} <b>${qScore}</b></span>
        </div>
        <div class="quiz-actions">
          <button id="regenBtn" class="btn secondary"><img src="assets/play.svg" class="icon themable" alt=""> ${window.LangManager.t('changeQuestion','Đổi câu khác')}</button>
          <span class="quiz-badge">${window.LangManager.t('ptsPerQ','+')}${perPoints()} ${window.LangManager.t('ptsPerQTail','đ/câu')}</span>
        </div>
      </div>
      <div class="mt-3 text-lg font-medium">${question}</div>
      <div id="choices" class="mt-3 grid gap-2"></div>
      <div id="explain" class="mt-3 hidden quiz-explain"></div>
      <div class="mt-3 quiz-actions">
        <button id="nextBtn" class="btn" disabled><img src="assets/play.svg" class="icon themable" alt=""> ${window.LangManager.t('nextQuestion','Câu tiếp')}</button>
      </div>
    `;

    const chWrap=document.getElementById('choices');
    const expEl=document.getElementById('explain');
    const next=document.getElementById('nextBtn');
    const regen=document.getElementById('regenBtn');

    let locked=false;
    options.forEach(opt=>{
      const div=document.createElement('label'); div.className='quiz-choice';
      div.innerHTML = `<input type="radio" name="opt" class="mt-1" style="accent-color:var(--primary)"> <div>${opt}</div>`;
      div.addEventListener('click', ()=>{
        if(locked) return; locked=true; next.disabled=false;
        const chosenLetter = opt.charAt(0).toUpperCase();
        const ok = (chosenLetter === correctAnswer);
        div.classList.add(ok?'correct':'wrong');
        if(!ok){
          [...chWrap.children].forEach(el=>{ if(el.textContent.trim().startsWith(correctAnswer)) el.classList.add('correct'); });
        }
        expEl.textContent = explanation || '';
        expEl.classList.remove('hidden');
        if(ok){ qScore += 1; qGained += perPoints(); }
      });
      chWrap.appendChild(div);
    });

    regen.addEventListener('click', ()=>{ renderQuiz(); });

    next.addEventListener('click', async()=>{
      qIdx++; setProg();
      if(qIdx>=10){
        wrap.innerHTML=`
          <div class="text-xl font-semibold">${window.LangManager.t('doneTitle','Hoàn thành!')}</div>
          <div class="mt-2">${window.LangManager.t('youCorrect','Bạn đúng')} <b>${qScore}</b>/10 ${window.LangManager.t('youCorrectTail','câu.')}</div>
          <div class="mt-2">${window.LangManager.t('youGained','Điểm thưởng vừa nhận:')} <b>+${qGained}</b></div>
          <div class="mt-3 quiz-actions">
            <a href="voucher.html" class="btn"><img src="assets/ticket.svg" class="icon themable" alt=""> ${window.LangManager.t('seeVoucher','Xem voucher')}</a>
            <button id="againBtn" class="btn secondary"><img src="assets/play.svg" class="icon themable" alt=""> ${window.LangManager.t('doAgain','Làm lại')}</button>
          </div>`;
        try{ await addPoints(qGained); }catch{}
        document.getElementById('againBtn').onclick=()=>{ qIdx=0;qScore=0;qGained=0; setProg(); renderQuiz(); };
      }else{
        renderQuiz();
      }
    });
  }

  function endQuiz(){ qIdx=0;qScore=0;qGained=0; $('#quizBox').classList.add('hidden'); $('#qwrap').innerHTML=''; setProg(); }

  /* ===================== Events ===================== */
  window.addEventListener('DOMContentLoaded', async ()=>{
    document.getElementById('loginBtn').onclick  = gotoLogin;
    document.getElementById('logoutBtn').onclick = ()=> auth.signOut();

    auth.onAuthStateChanged(async (u)=>{ updateAuthUI(u); if(u){ await loadPoints().catch(()=>{}); } });

    try { if(!auth.currentUser) await auth.signInAnonymously(); } catch(e){}

    await loadPoints();
    await loadPlaces();
    initMap();          
    await renderPlace();
    startGeowatch();

    document.getElementById('placeSelect').addEventListener('change', e=> selectPlace(e.target.value));
    document.getElementById('centerBtn').addEventListener('click', ()=> map && currentPlace?.coords && map.setView(currentPlace.coords,17));
    document.getElementById('locateBtn').addEventListener('click', ()=>{ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=> map.setView([pos.coords.latitude,pos.coords.longitude],17)); }});
    document.getElementById('aiReadBtn').addEventListener('click', aiRead);
    document.getElementById('stopReadBtn').addEventListener('click', stopRead);
    document.getElementById('startQuiz').addEventListener('click', ()=>{ qIdx=0;qScore=0;qGained=0; renderQuiz(); });
    document.getElementById('endQuiz').addEventListener('click', endQuiz);

    if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = ()=>{}; }
    updatePointsUI();
  });
  </script>

 <!-- Points / Level / XP (duy nhất, dùng chung với quiz) -->
  <script>
  const XP_PER_LEVEL = 100;     // 100 điểm = 1 level
  let points = 0;

  async function ensureAuth(){
    return new Promise((resolve)=>{
      auth.onAuthStateChanged(async (u)=>{ if (u) return resolve(u); try{ await auth.signInAnonymously(); }catch(e){ console.warn(e); } });
    });
  }

  const levelFromPoints = (p)=> Math.floor((Number(p)||0) / XP_PER_LEVEL) + 1;

  function updateXPUI(){
    const lv  = levelFromPoints(points);
    const cur = (Number(points)||0) % XP_PER_LEVEL;
    const pct = Math.max(0, Math.min(100, Math.round((cur/XP_PER_LEVEL)*100)));
    const fill = document.getElementById('xp-bar-fill');
    const lab  = document.getElementById('xp-label');
    if (fill) fill.style.width = pct + '%';
    if (lab)  lab.textContent  = `Lv ${lv} · ${cur}/${XP_PER_LEVEL}`;
  }

  function updatePointsUI(){
    const ptEl = document.getElementById('pointsText');
    const lvEl = document.getElementById('levelText');
    if (ptEl) ptEl.textContent = 'Điểm: ' + points;
    if (lvEl) lvEl.textContent = 'Level: ' + levelFromPoints(points);
    updateXPUI();
  }

  // ĐỌC điểm từ Firestore và đồng bộ xp/level
  async function loadPoints(){
    const u = auth.currentUser || await ensureAuth();
    const ref  = db.collection('users').doc(u.uid);
    const snap = await ref.get();

    const dbPoints = snap.exists ? ((snap.data().points ?? snap.data().xp) ?? 0) : 0;
    points = Number(dbPoints) || 0;

    await ref.set({
      points,
      xp: points,
      level: levelFromPoints(points),
      awarded_thresholds: snap.exists ? (snap.data().awarded_thresholds||[]) : []
    }, { merge: true });

    updatePointsUI();
  }

  // GHI điểm tuyệt đối và đồng bộ xp/level (+ gọi award nếu có)
  async function setPoints(v){
    const prev = points;
    points = Number(v)||0;
    updatePointsUI();

    const u = auth.currentUser || await ensureAuth();
    await db.collection('users').doc(u.uid).set({
      points,
      xp: points,
      level: levelFromPoints(points),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    if (typeof awardAfterPointsChange === 'function') {
      await awardAfterPointsChange(u, prev, points);
    }
  }

  async function addPoints(delta){ await setPoints((Number(points)||0) + (Number(delta)||0)); }
  </script>
  
<script>
  function sanitizeUsername(str){ return String(str||'').replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m])); }
  function displayNameFromUser(u){ if(!u) return 'Khách'; if(u.displayName) return u.displayName; if(u.email) return u.email.split('@')[0]; return `ID-${(u.uid||'').slice(0,6)}`; }
  function applyUserHeaderName(u){ var el = document.getElementById('userName'); if(el){ el.textContent = sanitizeUsername(displayNameFromUser(u)); } }
  if (typeof auth !== 'undefined' && auth && typeof auth.onAuthStateChanged === 'function') {
    auth.onAuthStateChanged(async (u)=>{ try { applyUserHeaderName(u); } catch(e){} try { if (typeof loadPoints === 'function') await loadPoints(); } catch(e){} });
  } else {
    document.addEventListener('DOMContentLoaded', function(){ applyUserHeaderName(null); });
  }
</script>

<script>
window.addEventListener('langchange', async ()=>{
  if (!currentPlace) return;  // tránh chạy sớm khi chưa load xong places
  await renderPlace();
});
</script>

<script>
    (function UsernameValidatorInit(){
      const NO_UNICODE_RE = /^[\x20-\x7E]+$/;
      const USERNAME_ASCII_RE = /^(?!.*\.\.)(?!.*__)(?!.*--)[A-Za-z0-9](?:[A-Za-z0-9._-]{0,28}[A-Za-z0-9])$/;

      function validateUsernameValue(val){
        const s = (val||"").trim();
        if(!NO_UNICODE_RE.test(s)) {
          return { ok:false, msg:"Chỉ cho phép ASCII, không ký tự Unicode." };
        }
        if(!USERNAME_ASCII_RE.test(s)) {
          return { ok:false, msg:"2–30 ký tự: A–Z a–z 0–9 . _ -, không đầu/cuối bằng . _ -, không có .. __ --" };
        }
        return { ok:true, msg:"" };
      }

      function attach(el){
        if(!el || el._usernameValidatorBound) return;
        el._usernameValidatorBound = true;

        el.setAttribute("autocomplete","username");
        el.setAttribute("spellcheck","false");
        el.setAttribute("autocapitalize","off");
        el.setAttribute("minlength","2");
        el.setAttribute("maxlength","30");

        el.addEventListener("input", () => {
          const {ok, msg} = validateUsernameValue(el.value);
          el.setCustomValidity(ok ? "" : msg);
          el.reportValidity();
        });

        el.form?.addEventListener("submit", (e) => {
          const {ok, msg} = validateUsernameValue(el.value);
          if(!ok){
            e.preventDefault();
            el.setCustomValidity(msg);
            el.reportValidity();
            el.focus();
          } else {
            el.setCustomValidity("");
          }
        });
      }

      document.querySelectorAll('input[name="username"], [data-username]').forEach(attach);

      const obs = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes.forEach(node=>{
            if(!(node instanceof Element)) return;
            if(node.matches?.('input[name="username"], [data-username]')) attach(node);
            node.querySelectorAll?.('input[name="username"], [data-username]').forEach(attach);
          });
        });
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});

      window.UsernameValidator = {
        validateRaw: (val)=> validateUsernameValue(val),
        regex: { NO_UNICODE_RE, USERNAME_ASCII_RE },
        attach
      };
    })();
  </script>
  
</body>
</html>


