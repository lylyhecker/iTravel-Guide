<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>404 - Kh√¥ng t√¨m th·∫•y trang</title>
  <meta name="description" content="Trang 404 cho iTravel Guide" />

  <!-- Favicon theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    body{margin:0; color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%), var(--bg);}

    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; text-decoration:none; }
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block;vertical-align:-0.2em}
    .icon.themable{ filter:none; transition:filter .2s ease; }
    :root[data-theme="dark"] img.icon.themable{ filter: invert(1) brightness(1.1) contrast(1.05); }
    .muted{ color: var(--muted); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4">
  <!-- Top-right controls -->
  <div class="fixed top-3 right-3 flex items-center gap-2">
    <!-- Theme toggle -->
    <button class="btn secondary" id="themeBtn" title="ƒê·ªïi giao di·ªán">
      <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
    </button>
    <!-- Language select -->
    <select id="langSelect" class="btn secondary" title="Language">
      <option value="vi">üáªüá≥ VI</option>
      <option value="en">üá¨üáß EN</option>
    </select>
  </div>

  <!-- Main 404 content -->
  <main class="card w-full max-w-2xl p-8 text-center">
    <h1 class="text-5xl font-extrabold">404</h1>
    <h2 class="text-2xl font-semibold mt-2 muted" data-i18n="oops">√îi kh√¥ng! Trang kh√¥ng t√¨m th·∫•y</h2>
    <p class="mt-4 muted" data-i18n="desc">
      C√≥ v·∫ª b·∫°n ƒë√£ l·∫°c ƒë∆∞·ªùng trong h√†nh tr√¨nh! Trang b·∫°n ƒëang t√¨m kh√¥ng t·ªìn t·∫°i.
      H√£y ki·ªÉm tra l·∫°i URL ho·∫∑c quay v·ªÅ trang ch·ªß ƒë·ªÉ ti·∫øp t·ª•c kh√°m ph√°.
    </p>

    <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
      <a href="index.html" class="btn">
        <img src="assets/homepage.svg" class="icon themable" alt="home">
        <span data-i18n="home">Trang ch·ªß</span>
      </a>
      <a href="login.html" class="btn secondary">
        <img src="assets/user.svg" class="icon themable" alt="login">
        <span data-i18n="login">ƒêƒÉng nh·∫≠p</span>
      </a>
    </div>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    /* ===================== Firebase init (same as index.html) ===================== */
    const firebaseConfig={
      apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain:"loginandsignin-4932b.firebaseapp.com",
      projectId:"loginandsignin-4932b",
      storageBucket:"loginandsignin-4932b.appspot.com",
      messagingSenderId:"863133586719",
      appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    /* ===================== ThemeSync v3 (reuse logic like index.html) ===================== */
    (function ThemeSyncV3(){
      const LS_KEY='voucher-theme';
      const root=document.documentElement;
      const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

      let current=null, uid=null, unsubUser=null, suppressNext=false;

      const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
      function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
      function applyTheme(t){
        current=t;
        t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
        // icon & favicon
        const icon=document.getElementById('themeIcon');
        if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
        const fav=document.getElementById('favicon');
        if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
        dispatchChange(t);
        if(bc) bc.postMessage({type:'theme-applied', theme:t});
      }
      function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
      function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

      async function setRemoteTheme(t){
        if(!uid) return;
        suppressNext=true;
        try{
          await firebase.firestore().collection('users').doc(uid).set({
            prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
          }, {merge:true});
        }finally{
          setTimeout(()=> suppressNext=false, 250);
        }
      }

      // API ƒë·ªÉ n√∫t b·∫•m g·ªçi
      window.ThemeManager={
        getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
        async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
        async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
      };
      document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

      // Sync ƒëa tab
      const bcInst = bc;
      if(bcInst){
        bcInst.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
      }

      // √Åp theme ban ƒë·∫ßu (kh√°ch)
      applyTheme(getLocal() || getSystem());

      // Login ‚Üí ƒë·ªìng b·ªô theo t√†i kho·∫£n
      firebase.auth().onAuthStateChanged(async (user)=>{
        if(unsubUser){ unsubUser(); unsubUser=null; }
        uid = user?.uid || null;

        if(!uid){ applyTheme(getLocal() || getSystem()); return; }

        const userRef=firebase.firestore().collection('users').doc(uid);
        const snap=await userRef.get();
        let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

        if(!remoteTheme){
          remoteTheme = getLocal() || getSystem();
          applyTheme(remoteTheme);
          setLocal(remoteTheme);
          await setRemoteTheme(remoteTheme);
        }else{
          setLocal(remoteTheme);
          applyTheme(remoteTheme);
        }

        unsubUser = userRef.onSnapshot(s=>{
          if(!s.exists) return;
          const t=s.data()?.prefs?.theme;
          if(!t) return;
          if(suppressNext) return;
          if(t!==current){ setLocal(t); applyTheme(t); }
        });
      });
    })();

    /* ===================== LangSync (Firestore i18n) for 404 ===================== */
    (function LangSync404(){
      const LS_KEY_LANG = 'app-lang';
      const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('lang-sync') : null;
      const sel = document.getElementById('langSelect');

      let uid = null, current = null, unsubUser = null, suppressNext = false;
      const dictCache = {};

      // Fallback t·ªëi thi·ªÉu (n·∫øu Firestore ch∆∞a c√≥ key)
      const fallback = {
        vi: {
          title404: '404 - Kh√¥ng t√¨m th·∫•y trang',
          oops: '√îi kh√¥ng! Trang kh√¥ng t√¨m th·∫•y',
          desc: 'C√≥ v·∫ª b·∫°n ƒë√£ l·∫°c ƒë∆∞·ªùng trong h√†nh tr√¨nh! Trang b·∫°n ƒëang t√¨m kh√¥ng t·ªìn t·∫°i. H√£y ki·ªÉm tra l·∫°i URL ho·∫∑c quay v·ªÅ trang ch·ªß ƒë·ªÉ ti·∫øp t·ª•c kh√°m ph√°.',
          home: 'Trang ch·ªß',
          login: 'ƒêƒÉng nh·∫≠p'
        },
        en: {
          title404: '404 - Page Not Found',
          oops: 'Oops! Page not found',
          desc: 'Looks like you took a wrong turn. The page you‚Äôre looking for doesn‚Äôt exist. Check the URL or head back to the homepage.',
          home: 'Home',
          login: 'Sign in'
        }
      };

      function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
      function getLocal(){ try{return localStorage.getItem(LS_KEY_LANG)}catch{return null} }
      function setLocal(v){ try{ localStorage.setItem(LS_KEY_LANG, v) }catch{} }

      async function loadDict(lang){
        if (dictCache[lang]) return dictCache[lang];
        try{
          const snap = await db.collection('i18n').doc(lang).get();
          if (snap.exists){
            dictCache[lang] = { ...fallback[lang], ...(snap.data()||{}) };
            return dictCache[lang];
          }
        }catch(e){}
        dictCache[lang] = fallback[lang] || {};
        return dictCache[lang];
      }

      function applyDict(dict){
        if(!dict) return;
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const k = el.getAttribute('data-i18n');
          if(k && dict[k]!=null) el.textContent = dict[k];
        });
        if (dict.title404) document.title = dict.title404;
        // c·∫≠p nh·∫≠t title cho n√∫t (optional)
        const loginBtn = document.querySelector('a[href="login.html"]');
        if (loginBtn && dict.login) loginBtn.title = dict.login;
      }

      async function applyLang(lang){
        current = lang;
        if (sel) sel.value = lang;
        setLocal(lang);
        const dict = await loadDict(lang);
        window.__i18n = dict;
        applyDict(dict);
        if (bc) bc.postMessage({ type:'lang-applied', lang });
        try{ window.dispatchEvent(new CustomEvent('langchange', { detail:{ lang } })); }catch{}
      }

      async function setRemote(lang){
        if(!uid) return;
        suppressNext = true;
        try{
          await db.collection('users').doc(uid).set({
            prefs: { lang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
          }, { merge: true });
        } finally {
          setTimeout(()=> suppressNext=false, 250);
        }
      }

      window.LangManager = {
        get(){ return current || getLocal() || sys(); },
        async set(lang){ if(!lang) return; await applyLang(lang); await setRemote(lang); },
        t(k, fb){ const d=window.__i18n||{}; return (d[k]!=null?d[k]:(fb||'')); }
      };

      sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

      // Kh·ªüi t·∫°o
      (async ()=>{
        const initial = getLocal() || sys();
        await applyLang(initial);
      })();

      // ƒê·ªìng b·ªô theo t√†i kho·∫£n (n·∫øu c√≥ ƒëƒÉng nh·∫≠p)
      auth.onAuthStateChanged(async (user)=>{
        if (unsubUser){ unsubUser(); unsubUser=null; }
        uid = user?.uid || null;

        if (!uid){ const lang = getLocal() || sys(); await applyLang(lang); return; }

        const userRef = db.collection('users').doc(uid);
        const snap = await userRef.get();
        let remote = snap.exists ? (snap.data()?.prefs?.lang || null) : null;

        if (!remote){
          remote = getLocal() || sys();
          await applyLang(remote);
          await setRemote(remote);
        } else {
          setLocal(remote);
          await applyLang(remote);
        }

        unsubUser = userRef.onSnapshot(s=>{
          if (!s.exists) return;
          const v = s.data()?.prefs?.lang;
          if (!v) return;
          if (suppressNext) return;
          if (v !== current){ setLocal(v); applyLang(v); }
        });
      });

      // Nh·∫≠n sync ƒëa tab
      if (bc){
        bc.onmessage = (ev)=>{
          if (ev?.data?.type === 'lang-applied'){
            const lang = ev.data.lang;
            if (lang && lang !== current){ applyLang(lang); }
          }
        };
      }
    })();
  </script>

  <!-- Username Validator (ch·∫∑n Unicode, ch·ªâ ASCII) -->
  <script>
    (function UsernameValidatorInit(){
      const NO_UNICODE_RE = /^[\x20-\x7E]+$/;
      const USERNAME_ASCII_RE = /^(?!.*\.\.)(?!.*__)(?!.*--)[A-Za-z0-9](?:[A-Za-z0-9._-]{0,28}[A-Za-z0-9])$/;

      function validateUsernameValue(val){
        const s = (val||"").trim();
        if(!NO_UNICODE_RE.test(s)) {
          return { ok:false, msg:"Ch·ªâ cho ph√©p ASCII, kh√¥ng k√Ω t·ª± Unicode." };
        }
        if(!USERNAME_ASCII_RE.test(s)) {
          return { ok:false, msg:"2‚Äì30 k√Ω t·ª±: A‚ÄìZ a‚Äìz 0‚Äì9 . _ -, kh√¥ng ƒë·∫ßu/cu·ªëi b·∫±ng . _ -, kh√¥ng c√≥ .. __ --" };
        }
        return { ok:true, msg:"" };
      }

      function attach(el){
        if(!el || el._usernameValidatorBound) return;
        el._usernameValidatorBound = true;

        el.setAttribute("autocomplete","username");
        el.setAttribute("spellcheck","false");
        el.setAttribute("autocapitalize","off");
        el.setAttribute("minlength","2");
        el.setAttribute("maxlength","30");

        el.addEventListener("input", () => {
          const {ok, msg} = validateUsernameValue(el.value);
          el.setCustomValidity(ok ? "" : msg);
          el.reportValidity();
        });

        el.form?.addEventListener("submit", (e) => {
          const {ok, msg} = validateUsernameValue(el.value);
          if(!ok){
            e.preventDefault();
            el.setCustomValidity(msg);
            el.reportValidity();
            el.focus();
          } else {
            el.setCustomValidity("");
          }
        });
      }

      document.querySelectorAll('input[name="username"], [data-username]').forEach(attach);

      const obs = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes.forEach(node=>{
            if(!(node instanceof Element)) return;
            if(node.matches?.('input[name="username"], [data-username]')) attach(node);
            node.querySelectorAll?.('input[name="username"], [data-username]').forEach(attach);
          });
        });
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});

      window.UsernameValidator = {
        validateRaw: (val)=> validateUsernameValue(val),
        regex: { NO_UNICODE_RE, USERNAME_ASCII_RE },
        attach
      };
    })();
  </script>
</body>
</html>
