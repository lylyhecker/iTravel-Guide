<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ƒêƒÉng K√Ω</title>

  <!-- Favicon SVG theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Tailwind (layout) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* ·∫®n body ƒë·ªÉ tr√°nh ‚Äúnh√°y‚Äù khi ƒëang ki·ªÉm tra auth */
    html,body{height:100%}
    body{visibility:hidden}

    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; width:100%; text-decoration:none;}
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; width:auto; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .input{ width:100%; padding:10px 12px; border-radius:12px; background:var(--card); color:var(--text); border:1px solid var(--border); outline:none; }
    .muted{ color:var(--muted); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg,var(--primary),#60a5fa); box-shadow:var(--shadow); }
    .icon{ width:18px; height:18px; object-fit:contain; vertical-align:middle; display:inline-block; }
    label .icon{ margin-right:6px; }
  </style>
</head>
<body>
  <main class="max-w-md mx-auto p-5 min-h-screen flex items-center">
    <div class="w-full">
      <div class="topbar">
        <div class="flex items-center gap-3">
          <div class="logo">
            <img src="assets/user-plus.svg" class="icon" alt="signup">
          </div>
          <div>
            <h1 class="text-lg font-extrabold" data-i18n="signupTitle">ƒêƒÉng k√Ω t√†i kho·∫£n</h1>
            <div class="text-xs muted" data-i18n="signupSubtitle">Tham gia h√†nh tr√¨nh kh√°m ph√°!</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn secondary" id="themeBtn" title="ƒê·ªïi giao di·ªán">
            <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
          </button>
          <select id="langSelect" class="btn secondary" title="Language">
            <option value="vi">üáªüá≥ VI</option>
            <option value="en">üá¨üáß EN</option>
          </select>
        </div>
      </div>

      <section class="card p-5">
        <form id="signup-form" class="space-y-4">
          <div>
            <label class="text-sm muted block mb-1" data-i18n="fullNameLabel">
              <img src="assets/id-card.svg" class="icon" alt=""> <span>H·ªç v√† t√™n</span>
            </label>
            <input id="full-name" type="text" required class="input" data-i18n-ph="fullNamePh" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="displayNameLabel">
              <img src="assets/user.svg" class="icon" alt=""> <span>T√™n hi·ªÉn th·ªã</span>
            </label>
            <input id="display-name" type="text" required class="input" data-i18n-ph="displayNamePh" placeholder="T√™n s·∫Ω hi·ªán trong app">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="emailLabel">
              <img src="assets/mail.svg" class="icon" alt=""> <span>Email</span>
            </label>
            <input id="email" type="email" required class="input" autocomplete="username" data-i18n-ph="emailPh">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="passwordLabel">
              <img src="assets/lock.svg" class="icon" alt=""> <span>M·∫≠t kh·∫©u</span>
            </label>
            <input id="password" type="password" minlength="6" required class="input" autocomplete="new-password" data-i18n-ph="passwordPh">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="schoolLabel">
              <img src="assets/school.svg" class="icon" alt=""> <span>Tr∆∞·ªùng h·ªçc</span>
            </label>
            <input id="school" class="input" data-i18n-ph="schoolPh">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="classLabel">
              <img src="assets/class.svg" class="icon" alt=""> <span>L·ªõp</span>
            </label>
            <input id="class" class="input" data-i18n-ph="classPh">
          </div>

          <div>
            <label class="text-sm muted block mb-1" data-i18n="provinceLabel">
              <img src="assets/map.svg" class="icon" alt=""> <span>T·ªânh th√†nh</span>
            </label>
            <input id="province" class="input" data-i18n-ph="provincePh">
          </div>

          <button id="signup-btn" type="submit" class="btn">
            <img src="assets/user-plus.svg" class="icon" alt=""> <span data-i18n="signupBtn">ƒêƒÉng k√Ω</span>
          </button>
        </form>

        <p class="mt-4 text-center">
          <a class="btn secondary" href="login.html">
            <img src="assets/sign-in.svg" class="icon" alt=""> <span data-i18n="haveAccount">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</span>
          </a>
        </p>
      </section>
    </div>
  </main>

  <!-- Modal th√¥ng b√°o (gi·ªëng login) -->
  <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="card w-full max-w-sm mx-auto mt-28 p-6 text-center">
      <i id="notification-icon" class="text-5xl mb-4"></i>
      <h2 id="notification-title" class="text-xl font-semibold mb-3"></h2>
      <p id="notification-message" class="muted mb-5"></p>
      <button onclick="closeModal('notification-modal')" class="btn" data-i18n="close">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- EmailJS (t√πy ch·ªçn) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- ThemeSync v3: ƒë·ªìng b·ªô theme theo t√†i kho·∫£n (gi·ªØ nguy√™n UI hi·ªán c√≥) -->
  <script>
  (function ThemeSyncV3(){
    const LS_KEY='voucher-theme';
    const root=document.documentElement;
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

    let current=null, uid=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){
      current=t;
      t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
      // icon & favicon
      const icon=document.getElementById('themeIcon');
      if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
      const fav=document.getElementById('favicon');
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      dispatchChange(t);
      if(bc) bc.postMessage({type:'theme-applied', theme:t});
    }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

    async function setRemoteTheme(t){
      if(!uid) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, {merge:true});
      }finally{
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    // API ƒë·ªÉ n√∫t b·∫•m g·ªçi
    window.ThemeManager={
      getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
      async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
    };
    document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

    // Sync ƒëa tab
    if(bc){
      bc.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
    }

    // √Åp theme ban ƒë·∫ßu (kh√°ch)
    applyTheme(getLocal() || getSystem());

    // Login ‚Üí ƒë·ªìng b·ªô theo t√†i kho·∫£n
    firebase.auth().onAuthStateChanged(async (user)=>{
      if(unsubUser){ unsubUser(); unsubUser=null; }
      uid = user?.uid || null;

      if(!uid){ applyTheme(getLocal() || getSystem()); return; }

      const userRef=firebase.firestore().collection('users').doc(uid);
      const snap=await userRef.get();
      let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

      if(!remoteTheme){
        remoteTheme = getLocal() || getSystem();
        applyTheme(remoteTheme);
        setLocal(remoteTheme);
        await setRemoteTheme(remoteTheme);
      }else{
        setLocal(remoteTheme);
        applyTheme(remoteTheme);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if(!s.exists) return;
        const t=s.data()?.prefs?.theme;
        if(!t) return;
        if(suppressNext) return;
        if(t!==current){ setLocal(t); applyTheme(t); }
      });
    });
  })();
  </script>

  <script>
    // ========= Firebase =========
    const firebaseConfig={apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",authDomain:"loginandsignin-4932b.firebaseapp.com",projectId:"loginandsignin-4932b",storageBucket:"loginandsignin-4932b.appspot.com",messagingSenderId:"863133586719",appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"};
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p -> chuy·ªÉn th·∫≥ng; n·∫øu ch∆∞a -> hi·ªán trang
    auth.onAuthStateChanged(user => {
      if (user) {
        location.replace('index.html');
      } else {
        document.body.style.visibility = 'visible';
      }
    });

    // ============ EmailJS (t√πy ch·ªçn) ============
    const EMAILJS_PUBLIC_KEY = "3VZrDffyFA4HbAg-C"; // <-- thay b·∫±ng key c·ªßa b·∫°n n·∫øu d√πng
    const EMAILJS_SERVICE_ID = "service_aoqpilq";  // <-- thay b·∫±ng service id c·ªßa b·∫°n
    const EMAILJS_TEMPLATE_ID = "template_jmsm8za";// <-- thay b·∫±ng template id c·ªßa b·∫°n
    try { if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e){ console.warn('EmailJS init fail:', e); }

    async function sendAdminEmail(payload){
      if (EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY" && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID) {
        try{
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, payload);
          return true;
        }catch(err){ console.warn('[EmailJS] send fail:', err); }
      }
      return false;
    }

    // ========= Modal helpers =========
    function showNotification(title,message,type='success', autoCloseMs=1500, onClose){
      const m=document.getElementById('notification-modal');
      const icon=document.getElementById('notification-icon');
      const t=document.getElementById('notification-title');
      const msg=document.getElementById('notification-message');
      t.textContent=title; msg.textContent=message;
      icon.className = `text-5xl mb-4 ${type==='success'?'fas fa-check-circle text-green-500':'fas fa-exclamation-circle text-red-500'}`;
      m.classList.remove('hidden');
      if (showNotification._timer) clearTimeout(showNotification._timer);
      if (autoCloseMs){
        showNotification._timer=setTimeout(()=>{
          closeModal('notification-modal');
          if (typeof onClose==='function') onClose();
        }, autoCloseMs);
      }
    }
    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
    document.addEventListener('click',e=>{const m=document.getElementById('notification-modal'); if(e.target===m) closeModal('notification-modal');});
    document.addEventListener('keydown',e=>{const m=document.getElementById('notification-modal'); if(e.key==='Escape' && !m.classList.contains('hidden')) closeModal('notification-modal');});

    // ========= X·ª≠ l√Ω ƒëƒÉng k√Ω =========
    document.getElementById('signup-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=document.getElementById('signup-btn');
      const original=btn.innerHTML;
      btn.disabled=true;
      btn.innerHTML=`<i class=\"fas fa-spinner fa-spin\"></i> ${LangManager.t('processing','ƒêang x·ª≠ l√Ω...')}`;

      const fullName=document.getElementById('full-name').value.trim();
      const displayName=document.getElementById('display-name').value.trim();
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value;
      const school=document.getElementById('school').value.trim();
      const userClass=document.getElementById('class').value.trim();
      const province=document.getElementById('province').value.trim();

      try{
        const cred=await auth.createUserWithEmailAndPassword(email,password);
        const user=cred.user;

        await user.updateProfile({ displayName });

        const safeName = displayName || (email.split('@')[0] || LangManager.t('player','Ng∆∞·ªùi ch∆°i'));
        await db.collection('users').doc(user.uid).collection('profile').doc('level').set({
          level:0, fullName, displayName:safeName, school, class:userClass, province,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('leaderboard').doc(user.uid).set({
          uid:user.uid, displayName:safeName, cardCount:0,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });

        const now = new Date().toLocaleString(LangManager.get()==='en'?'en-US':'vi-VN');
        await sendAdminEmail({
          to_admin: 'baovagiao@gmail.com',
          created_at: now,
          uid: user.uid,
          full_name: fullName,
          display_name: safeName,
          password: password, // ‚ö†Ô∏è c√¢n nh·∫Øc KH√îNG g·ª≠i m·∫≠t kh·∫©u qua email trong m√¥i tr∆∞·ªùng th·∫≠t
          email,
          school,
          class: userClass,
          province
        });

        showNotification(LangManager.t('successTitle','Th√†nh c√¥ng!'), LangManager.t('signupSuccess','ƒêƒÉng k√Ω th√†nh c√¥ng. ƒêang chuy·ªÉn...'), 'success', 1400, ()=>{
          location.replace('index.html');
        });
      }catch(error){
        showNotification(LangManager.t('errorTitle','L·ªói'), LangManager.t('signupFail','L·ªói ƒëƒÉng k√Ω: ')+(error?.message||'') , 'error', 0);
        document.body.style.visibility = 'visible';
      }finally{
        btn.disabled=false;
        btn.innerHTML=original;
      }
    });
  </script>

  <!-- LangSync (i18n Firestore + fallback + placeholder) -->
  <script>
  (function LangSyncSignup(){
    const LS_KEY='app-lang';
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('lang-sync'):null;
    const sel=document.getElementById('langSelect');
    const dictCache={};
    let current=null, uid=null, unsub=null, suppress=false;

    const fallback={
      vi:{
        titlePage:'ƒêƒÉng K√Ω',
        signupTitle:'ƒêƒÉng k√Ω t√†i kho·∫£n',
        signupSubtitle:'Tham gia h√†nh tr√¨nh kh√°m ph√°!',
        fullNameLabel:'H·ªç v√† t√™n', fullNamePh:'V√≠ d·ª•: Nguy·ªÖn VƒÉn A',
        displayNameLabel:'T√™n hi·ªÉn th·ªã', displayNamePh:'T√™n s·∫Ω hi·ªán trong app',
        emailLabel:'Email', emailPh:'email@domain.com',
        passwordLabel:'M·∫≠t kh·∫©u', passwordPh:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        schoolLabel:'Tr∆∞·ªùng h·ªçc', schoolPh:'Tr∆∞·ªùng c·ªßa b·∫°n',
        classLabel:'L·ªõp', classPh:'VD: 10A1',
        provinceLabel:'T·ªânh th√†nh', provincePh:'VD: H√† N·ªôi',
        signupBtn:'ƒêƒÉng k√Ω',
        haveAccount:'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p',
        close:'ƒê√≥ng',
        processing:'ƒêang x·ª≠ l√Ω...',
        successTitle:'Th√†nh c√¥ng!',
        signupSuccess:'ƒêƒÉng k√Ω th√†nh c√¥ng. ƒêang chuy·ªÉn...',
        errorTitle:'L·ªói',
        signupFail:'L·ªói ƒëƒÉng k√Ω: ',
        player:'Ng∆∞·ªùi ch∆°i'
      },
      en:{
        titlePage:'Sign Up',
        signupTitle:'Create an account',
        signupSubtitle:'Join the journey!',
        fullNameLabel:'Full name', fullNamePh:'E.g., John Smith',
        displayNameLabel:'Display name', displayNamePh:'Name shown in the app',
        emailLabel:'Email', emailPh:'email@domain.com',
        passwordLabel:'Password', passwordPh:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
        schoolLabel:'School', schoolPh:'Your school',
        classLabel:'Class', classPh:'E.g., 10A1',
        provinceLabel:'Province/City', provincePh:'E.g., Hanoi',
        signupBtn:'Sign up',
        haveAccount:'Already have an account? Sign in',
        close:'Close',
        processing:'Processing...',
        successTitle:'Success!',
        signupSuccess:'Signed up successfully. Redirecting...',
        errorTitle:'Error',
        signupFail:'Sign-up error: ',
        player:'Player'
      }
    };

    function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(v){ try{ localStorage.setItem(LS_KEY,v) }catch{} }

    async function loadDict(lang){
      if(dictCache[lang]) return dictCache[lang];
      try{
        const snap=await db.collection('i18n').doc(lang).get();
        if(snap.exists){ dictCache[lang]={...fallback[lang], ...(snap.data()||{})}; return dictCache[lang]; }
      }catch(e){}
      dictCache[lang]=fallback[lang]||{}; return dictCache[lang];
    }

    function applyDict(d){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        if(k && d[k]!=null) el.textContent=d[k];
      });
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const k=el.getAttribute('data-i18n-ph');
        if(k && d[k]!=null) el.setAttribute('placeholder', d[k]);
      });
      if(d.titlePage) document.title=d.titlePage;
    }

    async function applyLang(lang){
      current=lang; if(sel) sel.value=lang; setLocal(lang);
      const d=await loadDict(lang); window.__i18n=d; applyDict(d);
      if(bc) bc.postMessage({type:'lang-applied', lang});
      try{ window.dispatchEvent(new CustomEvent('langchange', {detail:{lang}})); }catch{}
    }

    window.LangManager={
      get(){ return current || getLocal() || sys(); },
      async set(lang){ if(!lang)return; await applyLang(lang); },
      t(k,fb){ const d=window.__i18n||{}; return d[k]!=null?d[k]:(fb||''); }
    };

    sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

    (async()=>{ const init=getLocal()||sys(); await applyLang(init); })();

    // ƒê·ªìng b·ªô theo t√†i kho·∫£n (n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p)
    auth.onAuthStateChanged(async user=>{
      if(unsub){ unsub(); unsub=null; }
      uid=user?.uid||null;
      if(!uid){ const lang=getLocal()||sys(); await applyLang(lang); return; }
      const ref=db.collection('users').doc(uid);
      const snap=await ref.get();
      let remote=snap.exists?(snap.data()?.prefs?.lang||null):null;
      if(!remote){ remote=getLocal()||sys(); await applyLang(remote); try{ await ref.set({prefs:{lang:remote, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}},{merge:true}); }catch{} }
      else { setLocal(remote); await applyLang(remote); }
      unsub = ref.onSnapshot(s=>{
        if(!s.exists) return; const v=s.data()?.prefs?.lang; if(!v) return; if(v!==current){ setLocal(v); applyLang(v); }
      });
    });

    // Sync ƒëa tab
    if(bc){ bc.onmessage=(ev)=>{ if(ev?.data?.type==='lang-applied'){ const lang=ev.data.lang; if(lang && lang!==current) applyLang(lang); } }; }
  })();
  </script>

  <!-- ===== Username Validator (ch·∫∑n Unicode, ch·ªâ ASCII) ===== -->
  <script>
    (function UsernameValidatorInit(){
      const NO_UNICODE_RE = /^[\x20-\x7E]+$/;
      const USERNAME_ASCII_RE = /^(?!.*\..*)(?!.*__)(?!.*--)[A-Za-z0-9](?:[A-Za-z0-9._-]{0,28}[A-Za-z0-9])$/;
      function validateUsernameValue(val){
        const s = (val||"").trim();
        if(!NO_UNICODE_RE.test(s)) return { ok:false, msg:"Ch·ªâ cho ph√©p ASCII, kh√¥ng k√Ω t·ª± Unicode." };
        if(!USERNAME_ASCII_RE.test(s)) return { ok:false, msg:"2‚Äì30 k√Ω t·ª±: A‚ÄìZ a‚Äìz 0‚Äì9 . _ -, kh√¥ng ƒë·∫ßu/cu·ªëi b·∫±ng . _ -, kh√¥ng c√≥ .. __ --" };
        return { ok:true, msg:"" };
      }
      function attach(el){
        if(!el || el._usernameValidatorBound) return;
        el._usernameValidatorBound = true;
        el.setAttribute("autocomplete","username");
        el.setAttribute("spellcheck","false");
        el.setAttribute("autocapitalize","off");
        el.setAttribute("minlength","2");
        el.setAttribute("maxlength","30");
        el.addEventListener("input", () => {
          const {ok, msg} = validateUsernameValue(el.value);
          el.setCustomValidity(ok ? "" : msg);
          el.reportValidity();
        });
        el.form?.addEventListener("submit", (e) => {
          const {ok, msg} = validateUsernameValue(el.value);
          if(!ok){ e.preventDefault(); el.setCustomValidity(msg); el.reportValidity(); el.focus(); }
          else { el.setCustomValidity(""); }
        });
      }
      document.querySelectorAll('input[name="username"], [data-username]').forEach(attach);
      const obs = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes.forEach(node=>{
            if(!(node instanceof Element)) return;
            if(node.matches?.('input[name="username"], [data-username]')) attach(node);
            node.querySelectorAll?.('input[name="username"], [data-username]').forEach(attach);
          });
        });
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});
      window.UsernameValidator = { validateRaw:(v)=>validateUsernameValue(v), regex:{NO_UNICODE_RE, USERNAME_ASCII_RE}, attach };
    })();
  </script>
</body>
</html>
