<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Th∆∞ vi·ªán Voucher</title>

  <!-- Tailwind ch·ªâ d√πng layout/spacing -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon (ThemeManager s·∫Ω ƒë·ªïi) -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg">

  <style>
    /* ========= THEME (y h·ªát quiz) ========= */
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .icon { width: 18px; height: 18px; object-fit: contain; display:inline-block }
    .muted{ color: var(--muted); }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background: var(--primary); color:white; font-weight:700;
      padding:10px 14px; border-radius:12px;
      transition: transform .12s ease, background .2s ease;
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--primary-strong); }
    .btn.secondary{ background: transparent; color: var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background: var(--bg-soft); }

    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background: var(--bg-soft) }

    /* üîí Tr·∫°ng th√°i disable cho voucher ƒë√£ d√πng/h·∫øt h·∫°n */
    .is-disabled{ opacity: .55; filter: grayscale(.3); }
    .btn[disabled], .btn.disabled, a.btn.disabled{ pointer-events: none !important; opacity: .6; cursor: not-allowed !important; }
  </style>
</head>
<body>
  <header class="app-header shadow-md">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl ring-1 ring-white/10 grid place-items-center" style="background:linear-gradient(135deg,var(--primary),#60a5fa)"><img src="assets/book.svg" class="icon" alt=""></div>
        <div>
          <h1 class="text-lg font-extrabold" data-i18n="libraryTitle">Th∆∞ vi·ªán Voucher</h1>
          <div class="text-xs muted" id="status" data-i18n="loading">ƒêang t·∫£i...</div>
        </div>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <a class="btn secondary" href="redeem.html"><img src="assets/gift.svg" class="icon" alt=""> <span data-i18n="redeem">ƒê·ªïi qu√†</span></a>
        <button class="btn secondary" id="themeBtn" title="ƒê·ªïi giao di·ªán"><img id="themeIcon" class="icon" alt=""></button>
        <select id="langSelect" class="btn secondary" title="Language">
          <option value="vi">üáªüá≥ VI</option>
          <option value="en">üá¨üáß EN</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="card p-5">
      <div class="flex items-center gap-3 justify-between flex-wrap mb-3">
        <h2 class="text-xl font-bold flex items-center gap-2"><img src="assets/voucher.svg" class="icon" alt=""> <span data-i18n="yourVouchers">Voucher c·ªßa b·∫°n</span></h2>
        <div class="flex gap-2">
          <input id="q" class="px-3 py-2 rounded-lg border" style="background:var(--card);color:var(--text);border-color:var(--border)" placeholder="T√¨m theo t√™n qu√†..." data-i18n-ph="searchPlaceholder">
          <button id="clearBtn" class="btn secondary" data-i18n="clear">Xo√°</button>
        </div>
      </div>

      <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="h-28 rounded-xl" style="background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06));animation:pulse 1.2s infinite"></div>
        <div class="h-28 rounded-xl" style="background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06));animation:pulse 1.2s infinite"></div>
        <div class="h-28 rounded-xl" style="background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.12),rgba(255,255,255,.06));animation:pulse 1.2s infinite"></div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-sm muted">
      ¬© 2025 Quiz & Assistant Web ‚Äî Design by Mr.Hecker
    </div>
  </footer>

  <!-- Firebase v8 (gi·ªØ nh∆∞ tr∆∞·ªõc) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const q = document.getElementById('q');
    const clearBtn = document.getElementById('clearBtn');

    let allDocs = [];

    const asDate = (v) => (v && typeof v.toDate === 'function') ? v.toDate() : (v ? new Date(v) : null);

    function computeExpiry(v){
      const expiresAt = asDate(v.expiresAt) || asDate(v.expiry);
      if (expiresAt) return expiresAt;
      const base = asDate(v.issuedAt) || asDate(v.createdAt) || asDate(v.redeemedAt) || new Date();
      const days = Number(v.validDays || 7);
      return new Date(base.getTime() + days*86400000);
    }

    async function backfillExpiresIfOwner(col, id, v, uid){
      if (v.expiresAt) return;
      if (!v.ownerUid || v.ownerUid !== uid) return;
      try{
        const base = asDate(v.issuedAt) || asDate(v.createdAt) || new Date();
        const days = Number(v.validDays || 7);
        const exp = new Date(base.getTime() + days*86400000);
        await db.collection(col).doc(id).set({ expiresAt: firebase.firestore.Timestamp.fromDate(exp) }, { merge:true });
      }catch{}
    }

    /* ‚ûï Th√™m status/used ƒë·ªÉ quy·∫øt ƒë·ªãnh disable */
    function toCardModel(col, id, v){
      const giftName = v.giftName || v.gift || 'Kh√¥ng r√µ';
      const expiry = computeExpiry(v);
      const expired = expiry ? (expiry.getTime() < Date.now()) : false;
      const status = (v.status || '').toLowerCase();
      const used = status === 'used';
      return { id, col, giftName, expiry, expired, status, used };
    }

    function dedupById(arr){
      const m = new Map();
      for (const x of arr) if (!m.has(x.id)) m.set(x.id, x);
      return Array.from(m.values());
    }

    async function fetchOwned(uid){ const s=await db.collection('vouchers').where('ownerUid','==',uid).get(); return s.docs.map(d=>({col:'vouchers',id:d.id,data:d.data()})); }
    async function fetchShared(uid){ const s=await db.collection('vouchers').where('allowedUids','array-contains',uid).get(); return s.docs.map(d=>({col:'vouchers',id:d.id,data:d.data()})); }
    async function fetchOwnedLegacy(uid){ try{ const s=await db.collection('voucher').where('ownerUid','==',uid).get(); return s.docs.map(d=>({col:'voucher',id:d.id,data:d.data()})); }catch{return []} }
    async function fetchSharedLegacy(uid){ try{ const s=await db.collection('voucher').where('allowedUids','array-contains',uid).get(); return s.docs.map(d=>({col:'voucher',id:d.id,data:d.data()})); }catch{return []} }
    async function fetchOwnedByUid(uid){ const s=await db.collection('vouchers').where('uid','==',uid).get(); return s.docs.map(d=>({col:'vouchers',id:d.id,data:d.data()})); }
    async function fetchOwnedByUidLegacy(uid){ try{ const s=await db.collection('voucher').where('uid','==',uid).get(); return s.docs.map(d=>({col:'voucher',id:d.id,data:d.data()})); }catch{return []} }

    async function fetchFromRedeemLogs(uid){
      try{
        const logs = await db.collection('redeem_logs').where('uid','==',uid).get();
        const vIds = Array.from(new Set(logs.docs.map(d => d.data()?.voucherId).filter(Boolean)));
        const results = [];
        for (const id of vIds){
          try{
            let snap = await db.collection('vouchers').doc(id).get();
            let col = 'vouchers';
            if (!snap.exists){
              const legacy = await db.collection('voucher').doc(id).get();
              if (!legacy.exists) continue;
              snap = legacy; col = 'voucher';
            }
            results.push({ col, id, data: snap.data() });
          }catch{}
        }
        return results;
      }catch{ return []; }
    }

    /* üîß Render: disable & b√¥i x√°m n·∫øu used/expired + i18n */
    function render(data){
      listEl.innerHTML = '';
      if (!data.length){
        listEl.innerHTML = `<div class="card p-4 text-center muted" data-i18n="noVouchers">${LangManager.t('noVouchers','Kh√¥ng c√≥ voucher n√†o.')}</div>`;
        return;
      }
      data.sort((a,b) => (a.expiry?.getTime()||9e15) - (b.expiry?.getTime()||9e15));
      for (const item of data){
        const isDisabled = item.used || item.expired;
        const badgeText = item.used ? LangManager.t('used','ƒê√£ d√πng') : (item.expired ? LangManager.t('expired','H·∫øt h·∫°n') : LangManager.t('valid','C√≤n h·∫°n'));

        const card = document.createElement('div');
        card.className = 'card p-4 flex flex-col gap-2' + (isDisabled ? ' is-disabled' : '');
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-bold text-base">${item.giftName}</h3>
            <span class="badge">${badgeText}</span>
          </div>
          <div class="muted text-sm">${LangManager.t('expiry','H·∫øt h·∫°n:')} ${item.expiry ? item.expiry.toLocaleString(LangManager.get()==='en'?'en-US':'vi-VN') : LangManager.t('noInfo','Kh√¥ng c√≥ th√¥ng tin')}</div>
          <div class="flex gap-2 mt-1">
            ${isDisabled
              ? `
                <a class="btn secondary disabled" aria-disabled="true" tabindex="-1">${LangManager.t('details','Chi ti·∫øt')}</a>
                <button class="btn" disabled>${LangManager.t('use','S·ª≠ d·ª•ng')}</button>
              `
              : `
                <a class="btn secondary" href="voucher.html?id=${encodeURIComponent(item.id)}">${LangManager.t('details','Chi ti·∫øt')}</a>
                <a class="btn" href="voucher.html?id=${encodeURIComponent(item.id)}">${LangManager.t('use','S·ª≠ d·ª•ng')}</a>
              `
            }
          </div>
        `;
        listEl.appendChild(card);
      }
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        statusEl.innerHTML = `${LangManager.t('needLogin','B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem.')} <a class="btn secondary" href="login.html">${LangManager.t('redeem','ƒê·ªïi qu√†')}</a>`;
        listEl.innerHTML = '';
        return;
      }
      statusEl.textContent = LangManager.t('loading','ƒêang t·∫£i...');

      try {
        const [own, shared, ownOld, sharedOld, ownByUid, ownByUidOld, fromLogs] = await Promise.all([
          fetchOwned(user.uid),
          fetchShared(user.uid),
          fetchOwnedLegacy(user.uid),
          fetchSharedLegacy(user.uid),
          fetchOwnedByUid(user.uid),        // fallback uid
          fetchOwnedByUidLegacy(user.uid),  // legacy + uid
          fetchFromRedeemLogs(user.uid)
        ]);

        const packs = dedupById([
          ...own, ...shared, ...ownOld, ...sharedOld, ...ownByUid, ...ownByUidOld, ...fromLogs
        ].map(x => ({ id:x.id, ...x })));

        const models = [];
        for (const p of packs){
          const v = p.data || {};
          try{ await backfillExpiresIfOwner(p.col, p.id, v, user.uid); }catch{}
          models.push(toCardModel(p.col, p.id, v));
        }

        render(models);
        statusEl.textContent = models.length
          ? LangManager.t('count','C√≥ {n} voucher').replace('{n}', String(models.length))
          : LangManager.t('none','B·∫°n ch∆∞a c√≥ voucher n√†o.');
        allDocs = models;
      } catch (err) {
        console.error(err);
        statusEl.textContent = LangManager.t('loadErr','L·ªói t·∫£i voucher: ') + (err.message || err);
        listEl.innerHTML = '';
      }
    });

    q.addEventListener('input', () => {
      const kw = q.value.trim().toLowerCase();
      if (!kw) return render(allDocs);
      render(allDocs.filter(x => (x.giftName || '').toLowerCase().includes(kw)));
    });
    clearBtn.addEventListener('click', () => { q.value = ''; render(allDocs); q.focus(); });
  </script>

  <!-- ThemeSync v3: ƒë·ªìng b·ªô theme theo t√†i kho·∫£n (gi·ªØ nguy√™n UI hi·ªán c√≥) -->
  <script>
  (function ThemeSyncV3(){
    const LS_KEY='voucher-theme';
    const root=document.documentElement;
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

    let current=null, uid=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){
      current=t;
      t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
      // icon & favicon
      const icon=document.getElementById('themeIcon');
      if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
      const fav=document.getElementById('favicon');
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      dispatchChange(t);
      if(bc) bc.postMessage({type:'theme-applied', theme:t});
    }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

    async function setRemoteTheme(t){
      if(!uid) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, {merge:true});
      }finally{
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    // API ƒë·ªÉ n√∫t b·∫•m g·ªçi
    window.ThemeManager={
      getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
      async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
    };
    document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

    // Sync ƒëa tab
    if(bc){
      bc.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
    }

    // √Åp theme ban ƒë·∫ßu (kh√°ch)
    applyTheme(getLocal() || getSystem());

    // Login ‚Üí ƒë·ªìng b·ªô theo t√†i kho·∫£n
    firebase.auth().onAuthStateChanged(async (user)=>{
      if(unsubUser){ unsubUser(); unsubUser=null; }
      uid = user?.uid || null;

      if(!uid){ applyTheme(getLocal() || getSystem()); return; }

      const userRef=firebase.firestore().collection('users').doc(uid);
      const snap=await userRef.get();
      let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

      if(!remoteTheme){
        remoteTheme = getLocal() || getSystem();
        applyTheme(remoteTheme);
        setLocal(remoteTheme);
        await setRemoteTheme(remoteTheme);
      }else{
        setLocal(remoteTheme);
        applyTheme(remoteTheme);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if(!s.exists) return;
        const t=s.data()?.prefs?.theme;
        if(!t) return;
        if(suppressNext) return;
        if(t!==current){ setLocal(t); applyTheme(t); }
      });
    });
  })();
  </script>

  <!-- LangSync: i18n Firestore + fallback + placeholder support -->
  <script>
  (function LangSync(){
    const LS_KEY = 'app-lang';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('lang-sync') : null;
    const sel = document.getElementById('langSelect');
    const dictCache = {};
    let current = null, uid = null, unsubUser = null, suppressNext = false;

    const fallback = {
      vi: {
        titlePage:'Th∆∞ vi·ªán Voucher',
        libraryTitle:'Th∆∞ vi·ªán Voucher',
        loading:'ƒêang t·∫£i...',
        redeem:'ƒê·ªïi qu√†',
        yourVouchers:'Voucher c·ªßa b·∫°n',
        searchPlaceholder:'T√¨m theo t√™n qu√†...',
        clear:'Xo√°',
        noVouchers:'Kh√¥ng c√≥ voucher n√†o.',
        used:'ƒê√£ d√πng',
        expired:'H·∫øt h·∫°n',
        valid:'C√≤n h·∫°n',
        details:'Chi ti·∫øt',
        use:'S·ª≠ d·ª•ng',
        expiry:'H·∫øt h·∫°n:',
        noInfo:'Kh√¥ng c√≥ th√¥ng tin',
        needLogin:'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem.',
        count:'C√≥ {n} voucher',
        none:'B·∫°n ch∆∞a c√≥ voucher n√†o.',
        loadErr:'L·ªói t·∫£i voucher: '
      },
      en: {
        titlePage:'Voucher Library',
        libraryTitle:'Voucher Library',
        loading:'Loading...',
        redeem:'Redeem',
        yourVouchers:'Your vouchers',
        searchPlaceholder:'Search by gift name...',
        clear:'Clear',
        noVouchers:'No vouchers.',
        used:'Used',
        expired:'Expired',
        valid:'Valid',
        details:'Details',
        use:'Use',
        expiry:'Expires:',
        noInfo:'No info',
        needLogin:'You need to login to view.',
        count:'You have {n} vouchers',
        none:'You have no vouchers.',
        loadErr:'Failed to load vouchers: '
      }
    };

    function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(v){ try{ localStorage.setItem(LS_KEY, v) }catch{} }

    async function loadDict(lang){
      if (dictCache[lang]) return dictCache[lang];
      try{
        const snap = await db.collection('i18n').doc(lang).get();
        if (snap.exists){ dictCache[lang] = { ...fallback[lang], ...(snap.data()||{}) }; return dictCache[lang]; }
      }catch(e){}
      dictCache[lang] = fallback[lang] || {}; return dictCache[lang];
    }

    function applyDict(dict){
      // textContent for [data-i18n]
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (k && dict[k] != null) el.textContent = dict[k];
      });
      // placeholder for [data-i18n-ph]
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const k = el.getAttribute('data-i18n-ph');
        if (k && dict[k] != null) el.setAttribute('placeholder', dict[k]);
      });
      if (dict.titlePage) document.title = dict.titlePage;
    }

    async function applyLang(lang){
      current = lang; if (sel) sel.value = lang; setLocal(lang);
      const dict = await loadDict(lang); window.__i18n = dict; applyDict(dict);
      if (bc) bc.postMessage({ type:'lang-applied', lang });
      try{ window.dispatchEvent(new CustomEvent('langchange', { detail:{ lang } })); }catch{}
    }

    window.LangManager = {
      get(){ return current || getLocal() || sys(); },
      async set(lang){ if (!lang) return; await applyLang(lang); },
      t(k, fb){ const d = window.__i18n || {}; return (d[k] != null ? d[k] : (fb||'')); }
    };

    sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

    (async ()=>{ const initial = getLocal() || sys(); await applyLang(initial); })();

    // ƒê·ªìng b·ªô theo t√†i kho·∫£n
    auth.onAuthStateChanged(async (user)=>{
      if (unsubUser){ unsubUser(); unsubUser = null; }
      uid = user?.uid || null;

      if (!uid){ const lang = getLocal() || sys(); await applyLang(lang); return; }

      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();
      let remoteLang = snap.exists ? (snap.data()?.prefs?.lang || null) : null;

      if (!remoteLang){
        remoteLang = getLocal() || sys();
        await applyLang(remoteLang);
        try{ await userRef.set({ prefs:{ lang:remoteLang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true }); }catch{}
      } else {
        setLocal(remoteLang);
        await applyLang(remoteLang);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if (!s.exists) return;
        const v = s.data()?.prefs?.lang; if (!v) return;
        if (suppressNext) return;
        if (v !== current){ setLocal(v); applyLang(v); }
      });
    });

    // Sync ƒëa tab
    if (bc){
      bc.onmessage = (ev)=>{
        if (ev?.data?.type === 'lang-applied'){
          const lang = ev.data.lang; if (lang && lang !== current) applyLang(lang);
        }
      };
    }
  })();
  </script>
</body>
</html>
