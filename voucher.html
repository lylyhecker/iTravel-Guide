<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chi ti·∫øt voucher</title>

  <!-- Tailwind for layout/spacing -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Favicon (ThemeManager will swap) -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <style>
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .icon { width: 18px; height: 18px; object-fit: contain; display:inline-block }
    .muted{ color: var(--muted); }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background: var(--primary); color:white; font-weight:700;
      padding:10px 14px; border-radius:12px;
      transition: transform .12s ease, background .2s ease;
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--primary-strong); }
    .btn.secondary{ background: transparent; color: var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background: var(--bg-soft); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; pointer-events:none }

    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; }
    .badge.ok{ color:#16a34a; border-color:#16a34a33; }
    .badge.err{ color:#ef4444; border-color:#ef444433; }
    .badge.warn{ color:#f59e0b; border-color:#f59e0b33; }

    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; }
    .kv .k{ color:var(--muted) }
    .kv .v{ }

    /* Toast */
    .toast{ position:fixed; top:16px; right:16px; max-width:360px; z-index:60; background:var(--card); color:var(--text); border:1px solid var(--border); border-left:4px solid var(--primary); border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); opacity:0; transform: translateY(-6px); transition: all .25s ease; pointer-events:none; }
    .toast.show{ opacity:1; transform:none; pointer-events:auto }
    .toast.success{ border-left-color:#22c55e } .toast.error{ border-left-color:#ef4444 } .toast.info{ border-left-color:var(--primary) }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header shadow-md">
    <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl ring-1 ring-white/10 grid place-items-center" style="background:linear-gradient(135deg,var(--primary),#60a5fa)">
          <img src="assets/voucher.svg" class="icon" alt="">
        </div>
        <div>
          <h1 class="text-lg font-extrabold" data-i18n="pageTitle">Chi ti·∫øt voucher</h1>
          <div class="text-xs muted" id="statusSub" data-i18n="loading">ƒêang t·∫£i...</div>
        </div>
      </div>

      <div class="flex items-center gap-3 flex-wrap">
        <a class="btn secondary" href="library.html"><img src="assets/book.svg" class="icon" alt=""> <span data-i18n="library">Th∆∞ vi·ªán</span></a>
        <button class="btn secondary" id="themeBtn" title="ƒê·ªïi giao di·ªán"><img id="themeIcon" class="icon" alt=""></button>
        <select id="langSelect" class="btn secondary" title="Language">
          <option value="vi">üáªüá≥ VI</option>
          <option value="en">üá¨üáß EN</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="card p-5">
      <div class="flex flex-col lg:flex-row gap-6">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <span id="statusBadge" class="badge warn" data-i18n="activeBadge">ƒêang hi·ªáu l·ª±c</span>
          </div>
          <h2 id="giftName" class="text-xl font-bold">‚Äî</h2>

          <div class="kv mt-4">
            <div class="k" data-i18n="codeLabel">M√£</div>
            <div class="v flex gap-2 items-center">
              <span id="voucherId">‚Äî</span>
              <button id="copyBtn" class="btn secondary btn-xs px-2 py-1" style="padding:4px 8px;font-size:12px"><img src="assets/copy.svg" class="icon" alt=""> <span data-i18n="copyCode">Copy</span></button>
            </div>

            <div class="k" data-i18n="issuedAt">Ng√†y c·∫•p</div>
            <div class="v"><span id="issuedAt">‚Äî</span></div>

            <div class="k" data-i18n="expiresAt">H·∫°n d√πng</div>
            <div class="v"><span id="expiresAt">‚Äî</span></div>

            <div class="k" data-i18n="timeLeft">Th·ªùi gian c√≤n l·∫°i</div>
            <div class="v"><span id="timeLeft">‚Äî</span></div>
          </div>

          <div class="mt-5 flex gap-2 flex-wrap">
            <a class="btn secondary" href="library.html"><img src="assets/back.svg" class="icon" alt=""> <span data-i18n="back">Quay l·∫°i</span></a>
            <button id="markUsedBtn" class="btn"><img src="assets/check.svg" class="icon" alt=""> <span data-i18n="markUsed">ƒê√°nh d·∫•u ƒë√£ d√πng</span></button>
            <button id="restoreBtn" class="btn secondary"><img src="assets/refresh.svg" class="icon" alt=""> <span data-i18n="restore">Kh√¥i ph·ª•c tr·∫°ng th√°i</span></button>
          </div>
        </div>

        <div class="w-full lg:w-72">
          <div class="text-sm muted mb-2" data-i18n="qrTitle">Qu√©t QR ƒë·ªÉ s·ª≠ d·ª•ng t·∫°i qu·∫ßy</div>
          <div id="qrcode" class="card p-4 grid place-items-center"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="max-w-4xl mx-auto px-4 py-4 text-center text-sm muted">
      ¬© 2025 Quiz & Assistant Web ‚Äî Design by Mr.Hecker
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast"><strong id="toast-title"></strong><div id="toast-msg" class="mt-1 text-sm"></div></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(); const db=firebase.firestore();

    const $=id=>document.getElementById(id);
    function toast(title,msg,type='info',after=null){
      const t=$('toast'); $('toast-title').textContent=title; $('toast-msg').textContent=msg;
      t.className='toast '+type; requestAnimationFrame(()=>t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); after&&after(); }, 2300);
    }

    function asDate(v){ return (v && typeof v.toDate==='function') ? v.toDate() : (v ? new Date(v) : null); }
    function fmt(d){ return d? d.toLocaleString(LangManager.get()==='en'?'en-US':'vi-VN') : '‚Äî'; }

    function parseVoucherId(){
      const u = new URL(location.href);
      const p = (u.searchParams.get('id')||'').trim();
      if (p) return p;
      const h = (u.hash||'').replace(/^#/, '');
      if (h) return h;
      const last = u.pathname.split('/').filter(Boolean).pop();
      if (last && last !== 'voucher.html') return last;
      return null;
    }

    async function fallbackLastVoucherId(){
      const user = auth.currentUser; if(!user) return null;
      try{ const snap=await db.collection('users').doc(user.uid).get(); return snap.data()?.last_voucher_id || null; }catch{return null}
    }

    async function fetchVoucherById(id){
      let snap = await db.collection('vouchers').doc(id).get();
      if (snap.exists) return { col:'vouchers', id, data:snap.data() };
      // legacy collection name
      snap = await db.collection('voucher').doc(id).get();
      if (snap.exists) return { col:'voucher', id, data:snap.data() };
      return null;
    }

    function statusFrom(v){
      const expiry = asDate(v.expiresAt) || asDate(v.expiry);
      const issued = asDate(v.issuedAt) || asDate(v.createdAt);
      const status = (v.status||'').toLowerCase();
      const expired = expiry ? (expiry.getTime() < Date.now()) : false;
      const used = status==='used' || v.used === true;
      return { expiry, issued, status, expired, used };
    }

    function humanTimeLeft(expiry){
      if (!expiry) return '‚Äî';
      const ms = expiry.getTime() - Date.now();
      if (ms <= 0) return LangManager.t('expiredBadge','ƒê√£ h·∫øt h·∫°n');
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      if (d>0) return `${d}d ${h}h ${m}m`;
      if (h>0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function setBadge(used, expired){
      const el=$('statusBadge');
      if (used){ el.className='badge err'; el.textContent=LangManager.t('usedBadge','ƒê√£ d√πng'); return; }
      if (expired){ el.className='badge err'; el.textContent=LangManager.t('expiredBadge','ƒê√£ h·∫øt h·∫°n'); return; }
      el.className='badge ok'; el.textContent=LangManager.t('activeBadge','ƒêang hi·ªáu l·ª±c');
    }

    let currentVoucherId=null, currentVoucherDoc=null;

    function fillUI(doc){
      $('giftName').textContent = doc.data.giftName || doc.data.gift || '‚Äî';
      $('voucherId').textContent = doc.id;
      const s = statusFrom(doc.data);
      $('issuedAt').textContent = fmt(s.issued);
      $('expiresAt').textContent = fmt(s.expiry);
      $('timeLeft').textContent = humanTimeLeft(s.expiry);
      setBadge(s.used, s.expired);

      // Buttons state
      const canUse = !s.used && !s.expired;
      $('markUsedBtn').disabled = !canUse;
      $('restoreBtn').disabled = s.used === false;

      // QR code
      const qEl = $('qrcode'); qEl.innerHTML='';
      const payload = JSON.stringify({ type:'voucher', id:doc.id, gift:doc.data.giftName||doc.data.gift||'' });
      new QRCode(qEl, { text: payload, width: 220, height: 220, colorDark: getComputedStyle(document.documentElement).getPropertyValue('--text')||'#111', colorLight: 'transparent', correctLevel: QRCode.CorrectLevel.M });
    }

    async function markUsedState(used){
      if (!currentVoucherDoc) return;
      const { col, id } = currentVoucherDoc;
      try{
        await db.collection(col).doc(id).set({ status: used?'used':'active', used: used || firebase.firestore.FieldValue.delete() }, { merge: true });
        // also write last_used_voucher_id
        const u = auth.currentUser; if(u){ await db.collection('users').doc(u.uid).set({ last_used_voucher_id: id }, { merge:true }); }
        const snap = await db.collection(col).doc(id).get();
        currentVoucherDoc = { col, id, data: snap.data() };
        fillUI(currentVoucherDoc);
        toast(LangManager.t('updateSuccess','C·∫≠p nh·∫≠t th√†nh c√¥ng'), used? LangManager.t('statusUsed','ƒê√£ ƒë√°nh d·∫•u l√† ƒë√£ d√πng.'): LangManager.t('statusActive','ƒê√£ kh√¥i ph·ª•c tr·∫°ng th√°i ho·∫°t ƒë·ªông.'), 'success');
      }catch(e){ toast(LangManager.t('updateFail','C·∫≠p nh·∫≠t th·∫•t b·∫°i'), e.message||'', 'error'); }
    }

    $('markUsedBtn').addEventListener('click', ()=> markUsedState(true));
    $('restoreBtn').addEventListener('click', ()=> markUsedState(false));
    $('copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(currentVoucherId||''); toast(LangManager.t('copied','ƒê√£ sao ch√©p'), currentVoucherId||'', 'info'); }catch{}
    });

    auth.onAuthStateChanged(async (user)=>{
      const id = parseVoucherId() || await fallbackLastVoucherId();
      currentVoucherId = id;
      if (!id){ $('statusSub').textContent = LangManager.t('notFoundMsg','Kh√¥ng t√¨m th·∫•y voucher.'); return; }
      $('statusSub').textContent = LangManager.t('loading','ƒêang t·∫£i...');
      try{
        const doc = await fetchVoucherById(id);
        if (!doc){ $('statusSub').textContent = LangManager.t('notFoundMsg','Kh√¥ng t√¨m th·∫•y voucher.'); return; }
        currentVoucherDoc = doc;
        fillUI(doc);
        $('statusSub').textContent = '';
      }catch(e){ $('statusSub').textContent = LangManager.t('loadErr','L·ªói t·∫£i voucher: ') + (e.message||e); }
    });
  </script>

  <!-- ThemeSync v3: ƒë·ªìng b·ªô theme theo t√†i kho·∫£n (gi·ªØ nguy√™n UI hi·ªán c√≥) -->
  <script>
  (function ThemeSyncV3(){
    const LS_KEY='voucher-theme';
    const root=document.documentElement;
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('theme-sync'):null;

    let current=null, uid=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia && matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){
      current=t;
      t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme');
      // icon & favicon
      const icon=document.getElementById('themeIcon');
      if(icon){ icon.src = t==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg'; icon.alt = t==='dark'?'Dark':'Light'; }
      const fav=document.getElementById('favicon');
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      dispatchChange(t);
      if(bc) bc.postMessage({type:'theme-applied', theme:t});
    }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(t){ try{ localStorage.setItem(LS_KEY,t) }catch{} }

    async function setRemoteTheme(t){
      if(!uid) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        }, {merge:true});
      }finally{
        setTimeout(()=> suppressNext=false, 250);
      }
    }

    // API ƒë·ªÉ n√∫t b·∫•m g·ªçi
    window.ThemeManager={
      getTheme(){ return current || root.getAttribute('data-theme') || getLocal() || getSystem(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark')return; applyTheme(t); setLocal(t); await setRemoteTheme(t); },
      async toggle(){ const next=this.getTheme()==='dark'?'light':'dark'; await this.setTheme(next); }
    };
    document.getElementById('themeBtn')?.addEventListener('click', ()=> window.ThemeManager.toggle());

    // Sync ƒëa tab
    if(bc){
      bc.onmessage=(ev)=>{ if(ev?.data?.type==='theme-applied'){ const t=ev.data.theme; if(t && t!==current) applyTheme(t); } };
    }

    // √Åp theme ban ƒë·∫ßu (kh√°ch)
    applyTheme(getLocal() || getSystem());

    // Login ‚Üí ƒë·ªìng b·ªô theo t√†i kho·∫£n
    firebase.auth().onAuthStateChanged(async (user)=>{
      if(unsubUser){ unsubUser(); unsubUser=null; }
      uid = user?.uid || null;

      if(!uid){ applyTheme(getLocal() || getSystem()); return; }

      const userRef=firebase.firestore().collection('users').doc(uid);
      const snap=await userRef.get();
      let remoteTheme = snap.exists ? (snap.data()?.prefs?.theme || null) : null;

      if(!remoteTheme){
        remoteTheme = getLocal() || getSystem();
        applyTheme(remoteTheme);
        setLocal(remoteTheme);
        await setRemoteTheme(remoteTheme);
      }else{
        setLocal(remoteTheme);
        applyTheme(remoteTheme);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if(!s.exists) return;
        const t=s.data()?.prefs?.theme;
        if(!t) return;
        if(suppressNext) return;
        if(t!==current){ setLocal(t); applyTheme(t); }
      });
    });
  })();
  </script>

  <!-- LangSync: i18n Firestore + fallback -->
  <script>
  (function LangSync(){
    const LS_KEY = 'app-lang';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('lang-sync') : null;
    const sel = document.getElementById('langSelect');
    const dictCache = {};
    let current = null, uid = null, unsubUser = null, suppressNext = false;

    const fallback = {
      vi: {
        titlePage:'Chi ti·∫øt voucher',
        pageTitle:'Chi ti·∫øt voucher',
        loading:'ƒêang t·∫£i...',
        library:'Th∆∞ vi·ªán',
        codeLabel:'M√£',
        giftLabel:'T√™n qu√†',
        issuedAt:'Ng√†y c·∫•p',
        expiresAt:'H·∫°n d√πng',
        timeLeft:'Th·ªùi gian c√≤n l·∫°i',
        expiredBadge:'ƒê√£ h·∫øt h·∫°n',
        usedBadge:'ƒê√£ d√πng',
        activeBadge:'ƒêang hi·ªáu l·ª±c',
        back:'Quay l·∫°i',
        markUsed:'ƒê√°nh d·∫•u ƒë√£ d√πng',
        restore:'Kh√¥i ph·ª•c tr·∫°ng th√°i',
        copyCode:'Copy',
        copied:'ƒê√£ sao ch√©p',
        notFoundMsg:'Kh√¥ng t√¨m th·∫•y voucher.',
        loadErr:'L·ªói t·∫£i voucher: ',
        updateSuccess:'C·∫≠p nh·∫≠t th√†nh c√¥ng',
        updateFail:'C·∫≠p nh·∫≠t th·∫•t b·∫°i',
        statusUsed:'ƒê√£ ƒë√°nh d·∫•u l√† ƒë√£ d√πng.',
        statusActive:'ƒê√£ kh√¥i ph·ª•c tr·∫°ng th√°i ho·∫°t ƒë·ªông.',
        qrTitle:'Qu√©t QR ƒë·ªÉ s·ª≠ d·ª•ng t·∫°i qu·∫ßy'
      },
      en: {
        titlePage:'Voucher details',
        pageTitle:'Voucher details',
        loading:'Loading...',
        library:'Library',
        codeLabel:'Code',
        giftLabel:'Gift',
        issuedAt:'Issued at',
        expiresAt:'Expires at',
        timeLeft:'Time left',
        expiredBadge:'Expired',
        usedBadge:'Used',
        activeBadge:'Active',
        back:'Back',
        markUsed:'Mark as used',
        restore:'Restore status',
        copyCode:'Copy',
        copied:'Copied',
        notFoundMsg:'Voucher not found.',
        loadErr:'Failed to load voucher: ',
        updateSuccess:'Updated successfully',
        updateFail:'Update failed',
        statusUsed:'Marked as used.',
        statusActive:'Restored to active.',
        qrTitle:'Scan QR at counter'
      }
    };

    function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(v){ try{ localStorage.setItem(LS_KEY, v) }catch{} }

    async function loadDict(lang){
      if (dictCache[lang]) return dictCache[lang];
      try{
        const snap = await db.collection('i18n').doc(lang).get();
        if (snap.exists){ dictCache[lang] = { ...fallback[lang], ...(snap.data()||{}) }; return dictCache[lang]; }
      }catch(e){}
      dictCache[lang] = fallback[lang] || {}; return dictCache[lang];
    }

    function applyDict(dict){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (k && dict[k] != null) el.textContent = dict[k];
      });
      if (dict.titlePage) document.title = dict.titlePage;
    }

    async function applyLang(lang){
      current = lang; if (sel) sel.value = lang; setLocal(lang);
      const dict = await loadDict(lang); window.__i18n = dict; applyDict(dict);
      if (bc) bc.postMessage({ type:'lang-applied', lang });
      try{ window.dispatchEvent(new CustomEvent('langchange', { detail:{ lang } })); }catch{}
    }

    window.LangManager = {
      get(){ return current || getLocal() || sys(); },
      async set(lang){ if (!lang) return; await applyLang(lang); },
      t(k, fb){ const d = window.__i18n || {}; return (d[k] != null ? d[k] : (fb||'')); }
    };

    sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

    (async ()=>{ const initial = getLocal() || sys(); await applyLang(initial); })();

    // ƒê·ªìng b·ªô theo t√†i kho·∫£n
    auth.onAuthStateChanged(async (user)=>{
      if (unsubUser){ unsubUser(); unsubUser = null; }
      uid = user?.uid || null;

      if (!uid){ const lang = getLocal() || sys(); await applyLang(lang); return; }

      const userRef = db.collection('users').doc(uid);
      const snap = await userRef.get();
      let remoteLang = snap.exists ? (snap.data()?.prefs?.lang || null) : null;

      if (!remoteLang){
        remoteLang = getLocal() || sys();
        await applyLang(remoteLang);
        try{ await userRef.set({ prefs:{ lang:remoteLang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true }); }catch{}
      } else {
        setLocal(remoteLang);
        await applyLang(remoteLang);
      }

      unsubUser = userRef.onSnapshot(s=>{
        if (!s.exists) return;
        const v = s.data()?.prefs?.lang; if (!v) return;
        if (suppressNext) return;
        if (v !== current){ setLocal(v); applyLang(v); }
      });
    });

    // Sync ƒëa tab
    if (bc){
      bc.onmessage = (ev)=>{
        if (ev?.data?.type === 'lang-applied'){
          const lang = ev.data.lang; if (lang && lang !== current) applyLang(lang);
        }
      };
    }
  })();
  </script>
</body>
</html>
