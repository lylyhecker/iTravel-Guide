<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voucher của tôi</title>

  <!-- Favicon theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; text-decoration:none; }
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block;vertical-align:-0.2em}

    .badge{border:1px solid var(--border); background:var(--bg-soft); border-radius:999px; padding:6px 10px}
    .muted{ color: var(--muted); }

    .tab { padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; cursor:pointer; }
    .tab.active { background:var(--primary); color:#fff; border-color:transparent; }
    .voucher-card{ border:1px dashed var(--border); border-radius:16px; background:var(--bg-soft); }
    .chip{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
    .chip.new{ background:rgba(37,99,235,.15); border-color:rgba(37,99,235,.4); }
    .chip.used{ background:rgba(107,114,128,.15); border-color:rgba(107,114,128,.4); }
    .chip.expired{ background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.4); }
    .grid-vouchers{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media(min-width:768px){ .grid-vouchers{ grid-template-columns: repeat(2, 1fr); } }
    @media(min-width:1200px){ .grid-vouchers{ grid-template-columns: repeat(3, 1fr); } }

    .input{ width:100%; padding:10px 12px; border-radius:12px; background:var(--card); color:var(--text); border:1px solid var(--border); outline:none; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="px-4 lg:px-8 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="assets/ticket.svg" class="icon" alt="ticket" />
      <h1 class="text-xl lg:text-2xl font-semibold">Voucher của tôi</h1>
      <span class="badge text-xs">Tài khoản</span>
    </div>

    <div class="flex items-center gap-2">
      <a href="index.html" class="btn secondary"><img src="assets/back.svg" class="icon" alt="back"> Trang chính</a>

      <button class="btn secondary" id="themeBtn" title="Đổi giao diện">
        <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
      </button>

      <button class="btn secondary" id="loginBtn">
        <img src="assets/user.svg" class="icon" alt=""> Đăng nhập
      </button>
      <button class="btn secondary hidden" id="logoutBtn">
        <img src="assets/exit.svg" class="icon" alt=""> Đăng xuất
      </button>
    </div>
  </header>

  <!-- Toolbar -->
  <section class="px-4 lg:px-8">
    <div class="card p-4">
      <div class="flex flex-col md:flex-row gap-3 md:items-center justify-between">
        <div class="flex items-center gap-2">
          <button class="tab active" data-filter="all">Tất cả</button>
          <button class="tab" data-filter="new">Mới</button>
          <button class="tab" data-filter="used">Đã dùng</button>
          <button class="tab" data-filter="expired">Hết hạn</button>
        </div>
        <div class="flex items-center gap-2">
          <img src="assets/search.svg" class="icon" alt="">
          <input id="search" class="input" placeholder="Tìm theo tiêu đề, mô tả, mã…" />
        </div>
      </div>
    </div>
  </section>

  <!-- Content -->
  <main class="px-4 lg:px-8 py-6">
    <div id="info" class="mb-3 text-sm muted"></div>
    <div id="voucherList" class="grid-vouchers"></div>
    <div id="empty" class="text-center muted mt-8 hidden">Chưa có voucher nào phù hợp.</div>
  </main>

  <!-- Dialog chi tiết -->
  <div id="dialog" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="card max-w-md w-full mx-auto mt-24 p-6 relative">
      <button id="dialogClose" class="absolute right-3 top-3 btn secondary p-2"><img src="assets/close.svg" class="icon" alt=""></button>
      <div id="dialogBody"></div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase init =====
    const firebaseConfig={
      apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain:"loginandsignin-4932b.firebaseapp.com",
      projectId:"loginandsignin-4932b",
      storageBucket:"loginandsignin-4932b.appspot.com",
      messagingSenderId:"863133586719",
      appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    // thông báo cho ThemeSync biết Firebase đã sẵn sàng (patch chuẩn)
    window.dispatchEvent(new Event('firebase-ready'));
  </script>

  <!-- ThemeSync V3: an toàn thứ tự + sync Firebase + đa tab -->
  <script>
  (function ThemeSyncV3(){
    const LS_KEY='app-theme';
    const root=document.documentElement;
    const btn=document.getElementById('themeBtn');
    const icon=document.getElementById('themeIcon');
    const fav=document.getElementById('favicon');
    const bc=('BroadcastChannel' in window)? new BroadcastChannel('theme-sync') : null;

    let current=null, unsubUser=null, suppressNext=false;

    const getSystem=()=> (matchMedia&&matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    const getLocal =()=>{ try{return localStorage.getItem(LS_KEY)}catch{return null} };
    const setLocal =(t)=>{ try{ localStorage.setItem(LS_KEY,t) }catch{} };
    const hasFB   =()=> !!(window.firebase && firebase.apps && firebase.apps.length);

    function applyTheme(t){
      current=t;
      if(t) root.setAttribute('data-theme',t); else root.removeAttribute('data-theme');
      if(icon){ icon.src = t==='dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg'; icon.alt=t||''; }
      if(fav){ fav.href = t==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg'; fav.href=fav.href.split('?')[0]+'?v='+Date.now(); }
      if(bc) bc.postMessage({type:'theme-applied',theme:t});
      setLocal(t);
      try{ window.dispatchEvent(new CustomEvent('themechange',{detail:{theme:t}})); }catch{}
    }

    async function setRemoteTheme(t){
      if(!hasFB()) return;
      const u=firebase.auth().currentUser; if(!u) return;
      suppressNext=true;
      try{
        await firebase.firestore().collection('users').doc(u.uid).set({
          prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
        },{merge:true});
      }finally{ setTimeout(()=> suppressNext=false, 250); }
    }

    function bindAuthWatcher(){
      if(!hasFB()) return;
      const auth=firebase.auth(), db=firebase.firestore();
      auth.onAuthStateChanged(async (user)=>{
        const loginBtn=document.getElementById('loginBtn');
        const logoutBtn=document.getElementById('logoutBtn');
        loginBtn?.classList.toggle('hidden', !!user);
        logoutBtn?.classList.toggle('hidden', !user);

        if(!user){
          applyTheme(getLocal()||getSystem());
          return;
        }
        const ref=db.collection('users').doc(user.uid);
        const snap=await ref.get();
        let t=snap.exists?(snap.data()?.prefs?.theme||null):null;
        if(!t){
          t=getLocal()||getSystem();
          applyTheme(t); await setRemoteTheme(t);
        }else{
          applyTheme(t); setLocal(t);
        }
        if(unsubUser){ try{unsubUser();}catch{} unsubUser=null; }
        unsubUser = ref.onSnapshot(s=>{
          if(!s.exists) return; const rt=s.data()?.prefs?.theme; if(!rt) return;
          if(suppressNext) return;
          if(rt!==current){ applyTheme(rt); setLocal(rt); }
        });
      });
    }

    btn?.addEventListener('click', async ()=>{
      const next=(current||getLocal()||getSystem())==='dark'?'light':'dark';
      applyTheme(next); await setRemoteTheme(next);
    });

    // Áp theme ngay (local/system) trước
    applyTheme(getLocal()||getSystem());

    if(bc){ bc.onmessage=(ev)=>{ const t=ev?.data?.theme; if(t && t!==current) applyTheme(t); }; }

    if((window.firebase && firebase.apps && firebase.apps.length)) bindAuthWatcher();
    else window.addEventListener('firebase-ready', bindAuthWatcher);
  })();
  </script>

  <!-- App script -->
  <script>
    const $ = (s)=> document.querySelector(s);
    function gotoLogin(){
      const ret = encodeURIComponent(location.href);
      location.href = `login.html?returnTo=${ret}`;
    }

    // UI elements
    const listEl   = document.getElementById('voucherList');
    const emptyEl  = document.getElementById('empty');
    const infoEl   = document.getElementById('info');
    const searchEl = document.getElementById('search');
    const tabs     = Array.from(document.querySelectorAll('.tab'));
    let FILTER = 'all';
    let VOUCHERS = [];

    // Auth buttons
    document.getElementById('loginBtn').addEventListener('click', gotoLogin);
    document.getElementById('logoutBtn').addEventListener('click', ()=> firebase.auth().signOut());

    // Tab filter
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=> x.classList.remove('active'));
        t.classList.add('active');
        FILTER = t.dataset.filter;
        render();
      });
    });

    // Search
    searchEl.addEventListener('input', ()=> render());

    function statusChip(s){
      const klass = s==='new'?'new': s==='used'?'used':'expired';
      const label = s==='new'?'Mới': s==='used'?'Đã dùng':'Hết hạn';
      return `<span class="chip ${klass}">${label}</span>`;
    }
    function fmtDate(dt){
      if(!dt) return '—';
      const d = dt instanceof Date ? dt : (dt?.toDate ? dt.toDate() : null);
      if(!d) return '—';
      return d.toLocaleDateString('vi-VN', {year:'numeric',month:'2-digit',day:'2-digit'});
    }

    function buildCard(v){
      const id  = v.id || '';
      const ttl = v.title || 'Voucher';
      const desc= v.description || '';
      const stt = v.status || 'new';
      const code= v.code || id.slice(0,8).toUpperCase();
      const created = v.createdAt || null;
      const expire  = v.expireAt || null;

      return `
      <div class="voucher-card p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold">${ttl}</div>
            <div class="text-sm muted mt-1">${desc}</div>
          </div>
          ${statusChip(stt)}
        </div>
        <div class="mt-3 flex items-center gap-2">
          <span class="badge">Mã: <b>${code}</b></span>
          <button class="btn secondary p-2" data-copy="${code}" title="Copy mã">
            <img src="assets/copy.svg" class="icon" alt="copy">
          </button>
          <button class="btn secondary p-2" data-detail="${id}" title="Xem chi tiết">
            <img src="assets/qr.svg" class="icon" alt="qr">
          </button>
        </div>
        <div class="mt-3 text-sm muted flex items-center gap-4">
          <span>Tạo: ${fmtDate(created)}</span>
          <span>Hết hạn: ${fmtDate(expire)}</span>
        </div>
      </div>`;
    }

    function render(){
      // filter + search
      const q = searchEl.value.trim().toLowerCase();
      let arr = VOUCHERS.slice();
      if(FILTER!=='all') arr = arr.filter(v=> (v.status||'new')===FILTER);
      if(q){
        arr = arr.filter(v=>{
          return (v.title||'').toLowerCase().includes(q)
              || (v.description||'').toLowerCase().includes(q)
              || (v.code||'').toLowerCase().includes(q)
              || (v.id||'').toLowerCase().includes(q);
        });
      }

      listEl.innerHTML = arr.map(buildCard).join('');
      emptyEl.classList.toggle('hidden', arr.length>0);

      // bind copy & detail
      listEl.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const text = btn.getAttribute('data-copy');
          navigator.clipboard?.writeText(text);
          btn.classList.add('ring-2'); setTimeout(()=> btn.classList.remove('ring-2'), 400);
        });
      });
      listEl.querySelectorAll('[data-detail]').forEach(btn=>{
        btn.addEventListener('click', ()=> openDetail(btn.getAttribute('data-detail')));
      });
    }

    function openDetail(id){
      const v = VOUCHERS.find(x=> x.id===id);
      if(!v) return;
      const code= v.code || v.id.slice(0,8).toUpperCase();
      const body = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xl font-semibold">${v.title||'Voucher'}</div>
            <div class="muted mt-1">${v.description||''}</div>
          </div>
          ${statusChip(v.status||'new')}
        </div>
        <div class="mt-4">
          <div class="badge">Mã voucher: <b>${code}</b></div>
        </div>
        <div class="mt-3 text-sm muted flex items-center gap-4">
          <span>Tạo: ${fmtDate(v.createdAt)}</span>
          <span>Hết hạn: ${fmtDate(v.expireAt)}</span>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <button class="btn" id="copyDetail"><img src="assets/copy.svg" class="icon" alt=""> Copy mã</button>
          <a class="btn secondary" href="redeem.html?code=${encodeURIComponent(code)}"><img src="assets/ticket.svg" class="icon" alt=""> Sử dụng voucher</a>
        </div>
      `;
      document.getElementById('dialogBody').innerHTML = body;
      document.getElementById('dialog').classList.remove('hidden');
      document.getElementById('copyDetail').onclick = ()=> navigator.clipboard?.writeText(code);
    }
    document.getElementById('dialogClose').addEventListener('click', ()=> document.getElementById('dialog').classList.add('hidden'));
    document.getElementById('dialog').addEventListener('click', (e)=>{ if(e.target.id==='dialog') e.currentTarget.classList.add('hidden'); });

    // Load vouchers for current user
    function bindData(){
      const auth=firebase.auth(); const db=firebase.firestore();
      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          infoEl.innerHTML = `Bạn chưa đăng nhập. <a class="underline" href="login.html?returnTo=${encodeURIComponent(location.href)}">Đăng nhập</a> để xem voucher.`;
          VOUCHERS=[]; render(); return;
        }
        infoEl.textContent = 'Đang tải voucher…';

        try{
          const qs = await db.collection('vouchers')
            .where('ownerUid','==',user.uid)
            .orderBy('createdAt','desc')
            .limit(200)
            .get();

          VOUCHERS = qs.docs.map(d=>{
            const x=d.data();
            return {
              id: d.id,
              title: x.title || 'Voucher',
              description: x.description || '',
              status: x.status || 'new',
              code: x.code || null,
              createdAt: x.createdAt || null,
              expireAt: x.expireAt || null
            };
          });

          infoEl.textContent = `Tổng: ${VOUCHERS.length} voucher`;
          render();
        }catch(err){
          infoEl.textContent = 'Không tải được voucher: ' + (err?.message||err);
        }
      });
    }

    // khởi động
    window.addEventListener('DOMContentLoaded', ()=>{
      bindData();
    });
  </script>
</body>
</html>
