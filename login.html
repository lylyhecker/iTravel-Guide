<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="titlePage">Đăng nhập</title>

  <!-- Favicon SVG theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FA icon cho spinner / alerts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* Ẩn body để tránh “nháy” khi đang kiểm tra auth */
    html,body{height:100%}
    body{visibility:hidden}

    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; width:100%; text-decoration:none; }
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; width:auto; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .btn.sso{ width:100%; background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none; }
    .btn.sso:hover{ background:var(--bg-soft); }
    .input{ width:100%; padding:10px 12px; border-radius:12px; background:var(--card); color:var(--text); border:1px solid var(--border); outline:none; }
    .muted{ color:var(--muted); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg,var(--primary),#60a5fa); box-shadow:var(--shadow); }
    .icon{ width:18px; height:18px; object-fit:contain; display:inline-block; vertical-align:middle; }
    #guestBtn{ width:100%; display:flex; align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <main class="max-w-md mx-auto p-5 min-h-screen flex items-center">
    <div class="w-full">
      <div class="topbar">
        <div class="flex items-center gap-3">
          <div class="logo">
            <img src="assets/login.svg" class="icon" alt="key">
          </div>
          <div>
            <h1 class="text-lg font-extrabold" data-i18n="loginTitle">Đăng nhập</h1>
            <div class="text-xs muted" id="status" data-i18n="continueSubtitle">Tiếp tục hành trình của bạn</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn secondary" id="themeBtn" title="Đổi giao diện">
            <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
          </button>
          <select id="langSelect" class="btn secondary" title="Language">
            <option value="vi">🇻🇳 VI</option>
            <option value="en">🇬🇧 EN</option>
          </select>
        </div>
      </div>

      <section class="card p-5">
        <form id="login-form" class="space-y-4">
          <div>
            <label class="text-sm muted block mb-1" data-i18n="emailLabel">
              <img src="assets/mail.svg" class="icon" alt="email"> Email
            </label>
            <input id="email" type="email" required class="input" autocomplete="username" data-i18n-ph="emailPh" />
          </div>
          <div>
            <label class="text-sm muted block mb-1" data-i18n="passwordLabel">
              <img src="assets/lock.svg" class="icon" alt="password"> Mật khẩu
            </label>
            <input id="password" type="password" minlength="6" required class="input" autocomplete="current-password" data-i18n-ph="passwordPh" />
          </div>
          <button id="login-btn" type="submit" class="btn">
            <img src="assets/sign-in.svg" class="icon" alt="login"> <span data-i18n="loginBtn">Đăng nhập</span>
          </button>
        </form>

        <!-- SSO Providers -->
        <div class="mt-4 grid grid-cols-1 gap-2">
          <button class="btn sso" id="googleBtn"><img src="assets/google.svg" class="icon" alt="google"> <span data-i18n="signinGoogle">Đăng nhập bằng Google</span></button>
          <button class="btn sso" id="githubBtn"><img src="assets/github.svg" class="icon" alt="github"> <span data-i18n="signinGithub">Đăng nhập bằng GitHub</span></button>
          <button class="btn sso" id="microsoftBtn"><img src="assets/microsoft.svg" class="icon" alt="microsoft"> <span data-i18n="signinMicrosoft">Đăng nhập bằng Microsoft</span></button>
        </div>

        <div class="mt-4">
          <button id="guestBtn" onclick="continueAsGuest()" class="btn secondary">
            <img src="assets/user.svg" class="icon" alt="guest"> <span data-i18n="guestBtn">Tiếp tục với tư cách khách</span>
          </button>
        </div>

        <p class="mt-4 text-center flex items-center justify-content-center gap-2 flex-wrap">
          <a class="btn secondary" href="forgot-password.html">
            <img src="assets/help.svg" class="icon" alt="forgot"> <span data-i18n="forgot">Quên mật khẩu?</span>
          </a>
          <span class="mx-2 muted">|</span>
          <a class="btn secondary" href="signup.html">
            <img src="assets/user-plus.svg" class="icon" alt="signup"> <span data-i18n="signup">Đăng ký</span>
          </a>
        </p>
      </section>
    </div>
  </main>

  <!-- Modal thông báo -->
  <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="card w-full max-w-sm mx-auto mt-28 p-6 text-center">
      <i id="notification-icon" class="text-5xl mb-4"></i>
      <h2 id="notification-title" class="text-xl font-semibold mb-3"></h2>
      <p id="notification-message" class="muted mb-5"></p>
      <button onclick="closeModal('notification-modal')" class="btn" data-i18n="close">Đóng</button>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <!-- Thêm Firestore để i18n -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- ThemeManager + đồng bộ favicon/icon -->
  <script>
    (function(){
      var ThemeManager;
      const LS_KEY='voucher-theme', root=document.documentElement;
      let currentTheme=null;
      const getSystemPref=()=> (window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
      function dispatchChange(theme){try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{}}
      function applyTheme(t){currentTheme=t; root.setAttribute('data-theme',t); dispatchChange(t);}
      function saveToLocal(t){try{localStorage.setItem(LS_KEY,t)}catch{}}

      (function(){ const ls=(()=>{try{return localStorage.getItem(LS_KEY)}catch{return null}})(); applyTheme(ls||getSystemPref()); })();
      document.getElementById('themeBtn')?.addEventListener('click', ()=> ThemeManager?.toggle());

      ThemeManager = {
        getTheme(){ return currentTheme || root.getAttribute('data-theme') || getSystemPref(); },
        setTheme(t){ if(t!=='light'&&t!=='dark') return; applyTheme(t); saveToLocal(t); },
        toggle(){ const cur=this.getTheme(); this.setTheme(cur==='dark'?'light':'dark'); }
      };
      window.ThemeManager = ThemeManager;

      function applyAssets(mode){
        const themeIcon = document.getElementById('themeIcon');
        const fav = document.getElementById('favicon');
        if(themeIcon){ themeIcon.src = mode==='dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg'; }
        if(fav){
          fav.href = mode==='dark' ? 'assets/favicon-dark.svg' : 'assets/favicon-light.svg';
          fav.href = fav.href.split('?')[0] + '?v=' + Date.now();
        }
      }
      applyAssets(ThemeManager.getTheme());
      window.addEventListener('themechange', e=> applyAssets(e.detail.theme));
    })();
  </script>

  <script>
    // Firebase
    const firebaseConfig={apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",authDomain:"loginandsignin-4932b.firebaseapp.com",projectId:"loginandsignin-4932b",storageBucket:"loginandsignin-4932b.appspot.com",messagingSenderId:"863133586719",appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"};
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    function getReturnTo(){
      try{ const u=new URL(location.href); return u.searchParams.get('returnTo'); }catch{return null}
    }

    // Kiểm tra trạng thái đăng nhập:
    auth.onAuthStateChanged(user => {
      if (user) {
        // đã đăng nhập -> chuyển tới returnTo hoặc index.html
        const rt = getReturnTo();
        location.replace(rt || 'index.html');
      } else {
        // chưa đăng nhập -> hiển thị trang
        document.body.style.visibility = 'visible';
      }
    });
  </script>

  <!-- LangSync (i18n Firestore + fallback + placeholder) -->
  <script>
  (function LangSyncLogin(){
    const LS_KEY='app-lang';
    const bc=('BroadcastChannel' in window)?new BroadcastChannel('lang-sync'):null;
    const sel=document.getElementById('langSelect');
    const dictCache={};
    let current=null, uid=null, unsub=null, suppress=false;

    const fallback={
      vi:{
        titlePage:'Đăng Nhập',
        loginTitle:'Đăng nhập',
        continueSubtitle:'Tiếp tục hành trình của bạn',
        emailLabel:'Email',
        emailPh:'email@domain.com',
        passwordLabel:'Mật khẩu',
        passwordPh:'•••••••',
        loginBtn:'Đăng nhập',
        guestBtn:'Tiếp tục với tư cách khách',
        forgot:'Quên mật khẩu?',
        signup:'Đăng ký',
        close:'Đóng',
        processing:'Đang xử lý...',
        successTitle:'Thành công!',
        successMsg:'Đăng nhập thành công! Đang chuyển hướng...',
        errorTitle:'Lỗi',
        errorLogin:'Lỗi đăng nhập: ',
        signinGoogle:'Đăng nhập bằng Google',
        signinGithub:'Đăng nhập bằng GitHub',
        signinMicrosoft:'Đăng nhập bằng Microsoft'
      },
      en:{
        titlePage:'Sign In',
        loginTitle:'Sign in',
        continueSubtitle:'Continue your journey',
        emailLabel:'Email',
        emailPh:'email@domain.com',
        passwordLabel:'Password',
        passwordPh:'•••••••',
        loginBtn:'Sign in',
        guestBtn:'Continue as guest',
        forgot:'Forgot password?',
        signup:'Sign up',
        close:'Close',
        processing:'Processing...',
        successTitle:'Success!',
        successMsg:'Signed in successfully! Redirecting...',
        errorTitle:'Error',
        errorLogin:'Sign-in error: ',
        signinGoogle:'Sign in with Google',
        signinGithub:'Sign in with GitHub',
        signinMicrosoft:'Sign in with Microsoft'
      }
    };

    function sys(){ const n=(navigator.language||'vi').toLowerCase(); return n.startsWith('vi')?'vi':'en'; }
    function getLocal(){ try{return localStorage.getItem(LS_KEY)}catch{return null} }
    function setLocal(v){ try{ localStorage.setItem(LS_KEY,v) }catch{} }

    async function loadDict(lang){
      if(dictCache[lang]) return dictCache[lang];
      try{
        const snap=await db.collection('i18n').doc(lang).get();
        if(snap.exists){ dictCache[lang]={...fallback[lang], ...(snap.data()||{})}; return dictCache[lang]; }
      }catch(e){}
      dictCache[lang]=fallback[lang]||{}; return dictCache[lang];
    }

    function applyDict(d){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        if(k && d[k]!=null) el.textContent=d[k];
      });
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const k=el.getAttribute('data-i18n-ph');
        if(k && d[k]!=null) el.setAttribute('placeholder', d[k]);
      });
      if(d.titlePage) document.title=d.titlePage;
    }

    async function applyLang(lang){
      current=lang; if(sel) sel.value=lang; setLocal(lang);
      const d=await loadDict(lang); window.__i18n=d; applyDict(d);
      if(bc) bc.postMessage({type:'lang-applied', lang});
      try{ window.dispatchEvent(new CustomEvent('langchange', {detail:{lang}})); }catch{}
    }

    window.LangManager={
      get(){ return current || getLocal() || sys(); },
      async set(lang){ if(!lang)return; await applyLang(lang); },
      t(k,fb){ const d=window.__i18n||{}; return d[k]!=null?d[k]:(fb||''); }
    };

    sel?.addEventListener('change', e=> window.LangManager.set(e.target.value));

    (async()=>{ const init=getLocal()||sys(); await applyLang(init); })();
  })();
  </script>

  <!-- Logic đăng nhập + thông báo (dùng i18n) + SSO -->
  <script>
    function showNotification(title,message,type='success'){
      const m=document.getElementById('notification-modal');
      document.getElementById('notification-title').textContent=title;
      document.getElementById('notification-message').textContent=message;
      document.getElementById('notification-icon').className =
        `text-5xl mb-4 ${type==='success'?'fas fa-check-circle text-green-500':'fas fa-exclamation-circle text-red-500'}`;
      m.classList.remove('hidden');
    }
    function closeModal(id){document.getElementById(id).classList.add('hidden');}

    function destination(){ try{ const u=new URL(location.href); return u.searchParams.get('returnTo') || 'index.html'; }catch{return 'index.html'} }

    document.getElementById('login-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=document.getElementById('login-btn');
      btn.disabled=true;
      btn.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${LangManager.t('processing','Đang xử lý...')}`;
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value;

      try{
        await auth.signInWithEmailAndPassword(email,password);
        showNotification(LangManager.t('successTitle','Thành công!'), LangManager.t('successMsg','Đăng nhập thành công! Đang chuyển hướng...'), 'success');
        setTimeout(()=>location.replace(destination()), 900);
      }catch(error){
        showNotification(LangManager.t('errorTitle','Lỗi'), LangManager.t('errorLogin','Lỗi đăng nhập: ')+(error?.message||''), 'error');
      }finally{
        btn.disabled=false;
        btn.innerHTML=`<img src="assets/sign-in.svg" class="icon" alt="login"> <span data-i18n="loginBtn">${LangManager.t('loginBtn','Đăng nhập')}</span>`;
        document.body.style.visibility = 'visible';
      }
    });

    // ====== SSO Providers ======
    function ssoPopup(provider){
      return auth.signInWithPopup(provider).catch(async (err)=>{
        if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user'){
          await auth.signInWithRedirect(provider);
          return null;
        }
        throw err;
      });
    }

    document.getElementById('googleBtn').addEventListener('click', async ()=>{
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await ssoPopup(provider);
        if (auth.currentUser){ showNotification(LangManager.t('successTitle','Thành công!'), LangManager.t('successMsg','Đăng nhập thành công! Đang chuyển hướng...'), 'success'); setTimeout(()=>location.replace(destination()), 600); }
      }catch(e){ showNotification(LangManager.t('errorTitle','Lỗi'), LangManager.t('errorLogin','Lỗi đăng nhập: ')+(e?.message||''), 'error'); }
    });

    document.getElementById('githubBtn').addEventListener('click', async ()=>{
      try{
        const provider = new firebase.auth.GithubAuthProvider();
        await ssoPopup(provider);
        if (auth.currentUser){ showNotification(LangManager.t('successTitle','Thành công!'), LangManager.t('successMsg','Đăng nhập thành công! Đang chuyển hướng...'), 'success'); setTimeout(()=>location.replace(destination()), 600); }
      }catch(e){ showNotification(LangManager.t('errorTitle','Lỗi'), LangManager.t('errorLogin','Lỗi đăng nhập: ')+(e?.message||''), 'error'); }
    });

    document.getElementById('microsoftBtn').addEventListener('click', async ()=>{
      try{
        const provider = new firebase.auth.OAuthProvider('microsoft.com');
        await ssoPopup(provider);
        if (auth.currentUser){ showNotification(LangManager.t('successTitle','Thành công!'), LangManager.t('successMsg','Đăng nhập thành công! Đang chuyển hướng...'), 'success'); setTimeout(()=>location.replace(destination()), 600); }
      }catch(e){ showNotification(LangManager.t('errorTitle','Lỗi'), LangManager.t('errorLogin','Lỗi đăng nhập: ')+(e?.message||''), 'error'); }
    });

    function continueAsGuest(){ location.href=destination(); }

    // Đóng modal khi click nền hoặc nhấn ESC
    document.addEventListener('click',e=>{const m=document.getElementById('notification-modal'); if(e.target===m) closeModal('notification-modal');});
    document.addEventListener('keydown',e=>{const m=document.getElementById('notification-modal'); if(e.key==='Escape' && !m.classList.contains('hidden')) closeModal('notification-modal');});
  </script>
</body>
</html>
